ì½˜í…ì¸ ë¡œ ê±´ë„ˆë›°ê¸°
ì±„íŒ… ê¸°ë¡

ë‚˜ì˜ ë§:
https://chatbot-dori.streamlit.app/

ì´ ì½”ë“œë¥¼ ì–´ë””ì„œ ì°¾ì•„ì•¼ í•˜ì§€? ìœˆë“œì„œí”„ì—ì„œ ì–´ë–»ê²Œ ê²€ìƒ‰ì„ í•´ì•¼í•˜ë‚˜
ChatGPTì˜ ë§:
ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.

1. ì§€ê¸ˆ ì£¼ì†Œ(https://chatbot-dori.streamlit.app/)ëŠ”
ë°°í¬ëœ Streamlit Cloud ì•± ì£¼ì†Œì˜ˆìš”.

ì—¬ê¸°ì—ëŠ” ì‹¤í–‰ëœ ê²°ê³¼ í™”ë©´ë§Œ ë³´ì´ê³ , ì‹¤ì œ ì†ŒìŠ¤ ì½”ë“œëŠ” ë³´ì´ì§€ ì•Šì•„ìš”.

ë”°ë¼ì„œ ì½”ë“œë¥¼ ì°¾ìœ¼ë ¤ë©´ Streamlit Cloudì— ë¡œê·¸ì¸í•´ì„œ ë³¸ì¸ì´ ì˜¬ë¦° ì €ì¥ì†Œ(GitHub ë“±)ì™€ ì—°ê²°ëœ ë¶€ë¶„ì„ í™•ì¸í•´ì•¼ í•´ìš”.

2. ì½”ë“œê°€ ì–´ë””ì— ìˆë‚˜?
ë³´í†µ Streamlit Cloudì—ì„œ ì•±ì„ ë„ìš¸ ë•ŒëŠ”

GitHub ì €ì¥ì†Œ(ë ˆí¬)ì™€ ì—°ê²°í•˜ê±°ë‚˜,

ì§ì ‘ .py íŒŒì¼ì„ ì—…ë¡œë“œí•´ì„œ ì‹¤í–‰í•´ìš”.

ë”°ë¼ì„œ ì†ŒìŠ¤ ì½”ë“œëŠ” GitHub ì €ì¥ì†Œ ë˜ëŠ” ìœˆë“œì„œí”„(Windsurf IDE) í”„ë¡œì íŠ¸ ì•ˆì— ìˆì–´ìš”.

3. ìœˆë“œì„œí”„ì—ì„œ ì°¾ëŠ” ë°©ë²•
ìœˆë“œì„œí”„ëŠ” ë³´í†µ GitHubì™€ ì—°ë™í•´ì„œ ì‘ì—…í•˜ë‹ˆê¹Œ, ì½”ë“œ ì°¾ëŠ” ìˆœì„œëŠ” ì´ë ‡ê²Œ í•˜ì‹œë©´ ë¼ìš”:

ìœˆë“œì„œí”„ì—ì„œ GitHub ë ˆí¬ ì—´ê¸°

ì‚¬ì´ë“œë°”ì—ì„œ Source Control ì•„ì´ì½˜ í´ë¦­ â†’ ì—°ê²°ëœ GitHub ë ˆí¬ í™•ì¸.

íŒŒì¼ëª…ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸°

ë‹¨ì¶•í‚¤: Ctrl + P (Quick Open)

ë³´í†µ streamlit_app.py ë˜ëŠ” app.pyë¼ëŠ” ì´ë¦„ì„ ì¨ìš”.

ê²€ìƒ‰ì°½ì— streamlit_app.py ë˜ëŠ” app.py ì…ë ¥.

ì½”ë“œ ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸°

ë‹¨ì¶•í‚¤: Ctrl + Shift + F (ì „ì²´ ê²€ìƒ‰)

ì˜ˆ: st.set_page_config ë˜ëŠ” st.title ê°™ì€ Streamlit ì „ìš© í•¨ìˆ˜ ê²€ìƒ‰.

ì´ë ‡ê²Œ í•˜ë©´ Streamlit ê´€ë ¨ ì½”ë“œ íŒŒì¼ì„ ë°”ë¡œ ì°¾ì„ ìˆ˜ ìˆì–´ìš”.

ğŸ‘‰ ë„ë¦¬, í˜¹ì‹œ ì œê°€ ë°”ë¡œ ìœˆë“œì„œí”„ì—ì„œ chatbot-dori í”„ë¡œì íŠ¸ ì†ŒìŠ¤ ìœ„ì¹˜ë¥¼ ê²€ìƒ‰í•´ ë“œë¦´ê¹Œìš”?
ì•„ë‹ˆë©´ GitHub ì£¼ì†Œë¥¼ ì—°ê²°í•´ ë‘” ê²Œ ìˆë‚˜ìš”?

ë‚˜ì˜ ë§:
https://github.com/DoriChoi/chatbot_250904_dori

ìš”ê¸°ì— ìˆì–´ ë‹¤ë§Œ ìœˆë“œì„œí”„ì—ì„œ ìˆ˜ì •í•´ì„œ ë‹¤ì‹œ ì—…ë°ì´íŠ¸ í•˜ë ¤ê³  í•˜ëŠ”ë° ê¸°ì¡´ ì†ŒìŠ¤ê°€ ì–´ë”” ìˆëŠ”ì§€ ëª¨ë¥´ê² ì–´
ChatGPTì˜ ë§:
ì¢‹ì•„ìš”, ì´ì œ ê·¸ë¦¼ì´ ì¡°ê¸ˆ ë” ëª…í™•í•´ì¡Œë„¤ìš”. ë„ë¦¬ì˜ ìƒí™©ì„ ì •ë¦¬í•˜ë©´:

ì•± ì£¼ì†Œ: https://chatbot-dori.streamlit.app/ â†’ ì´ê±´ ì‹¤í–‰ í™”ë©´ì¼ ë¿, ì½”ë“œ ìœ„ì¹˜ëŠ” ì•ˆ ë³´ì„.

ì‹¤ì œ ì½”ë“œ ì €ì¥ì†Œ: https://github.com/DoriChoi/chatbot_250904_dori â†’ ì—¬ê¸° ì•ˆì— ìˆìŒ.

ëª©í‘œ: ìœˆë“œì„œí”„(Windsurf IDE)ì—ì„œ ì´ ì €ì¥ì†Œ ì½”ë“œë¥¼ ì—´ê³  ìˆ˜ì • í›„ ë‹¤ì‹œ ë°°í¬.

1. ì½”ë“œê°€ ì–´ë”” ìˆëŠ”ì§€
í•´ë‹¹ GitHub ì €ì¥ì†Œ ì•ˆì—ì„œ Streamlit ì•±ì€ ë³´í†µ streamlit_app.py í˜¹ì€ **app.py**ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì— ìˆì–´ìš”.
ğŸ‘‰ ìœˆë“œì„œí”„ì—ì„œ ê²€ìƒ‰í•  ë•ŒëŠ”:

ë‹¨ì¶•í‚¤ Ctrl + P â†’ streamlit_app.py ì…ë ¥ (íŒŒì¼ëª… ê²€ìƒ‰)

ë‹¨ì¶•í‚¤ Ctrl + Shift + F â†’ st.set_page_config ê°™ì€ Streamlit ì „ìš© í•¨ìˆ˜ë¡œ ê²€ìƒ‰ (ë‚´ìš© ê²€ìƒ‰)

ì´ë ‡ê²Œ í•˜ë©´ ì†ŒìŠ¤ íŒŒì¼ì´ ë°”ë¡œ ì¡í ê±°ì˜ˆìš”.

2. ìœˆë“œì„œí”„ì—ì„œ ê¸°ì¡´ ì†ŒìŠ¤ ì°¾ê¸°
ìœˆë“œì„œí”„ì—ì„œëŠ” GitHubì™€ ì—°ê²°ëœ ë ˆí¬ë¥¼ ë¶ˆëŸ¬ì™€ì•¼ í•´ìš”.

ìœˆë“œì„œí”„ ì‹œì‘ í™”ë©´ â†’ "Clone from GitHub" ì„ íƒ

https://github.com/DoriChoi/chatbot_250904_dori ì£¼ì†Œ ë¶™ì—¬ë„£ê¸°

ë¡œì»¬ì— ë‚´ë ¤ë°›ì€ í›„, ì™¼ìª½ íŒŒì¼ íƒìƒ‰ê¸°ì—ì„œ streamlit_app.py ê°™ì€ íŒŒì¼ì„ ì—´ë©´ ë¨

3. ì—…ë°ì´íŠ¸ & ë°°í¬ ì ˆì°¨
ìœˆë“œì„œí”„ì—ì„œ ì½”ë“œ ìˆ˜ì •

GitHubì— commit & push

Streamlit Cloudì—ì„œ í•´ë‹¹ GitHub ì €ì¥ì†Œì™€ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒˆ ë²„ì „ ë°°í¬ë¨

ğŸ‘‰ ë„ë¦¬, ì œê°€ GitHub ì €ì¥ì†Œ êµ¬ì¡°ë¥¼ ì§ì ‘ ì—´ì–´ì„œ streamlit_app.pyê°€ ì •í™•íˆ ì–´ë”” ìˆëŠ”ì§€ í™•ì¸í•´ ë“œë¦´ê¹Œìš”? (ì˜ˆ: / ë£¨íŠ¸ì— ìˆëŠ”ì§€, app/ í´ë” ì•ˆì— ìˆëŠ”ì§€)

ë‚˜ì˜ ë§:
ã…‡ã…‡
ChatGPTì˜ ë§:
ì½”ë“œ êµ¬ì¡° ë´¤ê³ , streamlit_app.py íŒŒì¼ì´ ë ˆí¬ ë£¨íŠ¸ì— ìˆì–´ìš”. 
GitHub

ğŸ“‚ íŒŒì¼ ìœ„ì¹˜ ìš”ì•½
chatbot_250904_dori/
  â”œâ”€â”€ .devcontainer/
  â”œâ”€â”€ .github/
  â”œâ”€â”€ .gitignore
  â”œâ”€â”€ LICENSE
  â”œâ”€â”€ README.md
  â”œâ”€â”€ requirements.txt
  â””â”€â”€ **streamlit_app.py**
âœ… ë‹¹ì‹ ì´ í•´ì•¼ í•  ì¼ (ìœˆë“œì„œí”„ì—ì„œ ìˆ˜ì • â†’ ë°°í¬)
ìœˆë“œì„œí”„ì—ì„œ GitHub ë ˆí¬ DoriChoi/chatbot_250904_dori í´ë¡ 

streamlit_app.py íŒŒì¼ ì—´ê¸°

ì½”ë“œ ìˆ˜ì •

ì»¤ë°‹ & í‘¸ì‹œ (GitHubì— ì ìš©)

Streamlit Cloud ë°°í¬ ìë™ í˜¹ì€ ìˆ˜ë™ ë¦¬ë¹Œë“œ

í•„ìš”í•˜ë©´ ê° ë‹¨ê³„ ë” êµ¬ì²´ì ìœ¼ë¡œ ë„ì™€ë“œë¦´ê¹Œìš”?

ë‚˜ì˜ ë§:
1
ChatGPTì˜ ë§:
ì¢‹ìŠµë‹ˆë‹¤, ë„ë¦¬. ê·¸ëŸ¼ **1ë‹¨ê³„ (ìœˆë“œì„œí”„ì—ì„œ GitHub ë ˆí¬ í´ë¡ í•˜ê¸°)**ë¥¼ ìì„¸íˆ ì•Œë ¤ë“œë¦´ê²Œìš”.

1. GitHub ë ˆí¬ í´ë¡  (ìœˆë“œì„œí”„ì—ì„œ)
ìœˆë“œì„œí”„ ì‹¤í–‰
â†’ ì²« í™”ë©´ ë˜ëŠ” ìƒë‹¨ ë©”ë‰´ì—ì„œ â€œClone Repositoryâ€ ì„ íƒ

GitHub URL ì…ë ¥

https://github.com/DoriChoi/chatbot_250904_dori.git
ì €ì¥ ìœ„ì¹˜ ì„ íƒ
â†’ ë¡œì»¬ì— ì €ì¥í•  í´ë” ì§€ì •

í´ë¡  ì™„ë£Œ í›„, ì™¼ìª½ íŒŒì¼ íƒìƒ‰ê¸°ì— í”„ë¡œì íŠ¸ êµ¬ì¡°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
â†’ ì—¬ê¸°ì„œ streamlit_app.py íŒŒì¼ í™•ì¸ ê°€ëŠ¥

ğŸ‘‰ ì—¬ê¸°ê¹Œì§€ í•˜ë©´ ë¡œì»¬ì— ì½”ë“œê°€ ì¤€ë¹„ë¼ìš”.
ë„ë¦¬, ì›í•˜ì‹œë©´ ì œê°€ 2ë‹¨ê³„ (streamlit_app.py íŒŒì¼ ì—´ê¸° â†’ ìˆ˜ì •) ë°©ë²•ë„ ì´ì–´ì„œ ì•Œë ¤ë“œë¦´ê¹Œìš”?

ë‚˜ì˜ ë§:
â†’ ì²« í™”ë©´ ë˜ëŠ” ìƒë‹¨ ë©”ë‰´ì—ì„œ â€œClone Repositoryâ€ ì„ íƒ

ì´ê²Œ ì•ˆ ë³´ì—¬ ì–´ë””ì— ìˆëŠ”ê±°ì•¼?
ChatGPTì˜ ë§:
ë„ë¦¬, ìœˆë“œì„œí”„ ì²« í™”ë©´ì—ì„œ **â€œClone Repositoryâ€**ê°€ ì•ˆ ë³´ì´ëŠ” ê±´ í™˜ê²½ì— ë”°ë¼ UIê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì´ì—ìš”. ëŒ€ì‹  ì´ë ‡ê²Œ ì°¾ì•„ë³´ì„¸ìš”:

1. Command Paletteì—ì„œ ì‹¤í–‰
ë‹¨ì¶•í‚¤: Ctrl + Shift + P (ë§¥ì´ë©´ Cmd + Shift + P)

ê²€ìƒ‰ì°½ì— Clone ì…ë ¥ â†’ Git: Clone ì„ íƒ

ì—¬ê¸°ì„œ GitHub URL (https://github.com/DoriChoi/chatbot_250904_dori.git) ë„£ìœ¼ë©´ ë¼ìš”.

2. ë©”ë‰´ ê²½ë¡œë¡œ ì ‘ê·¼
ìƒë‹¨ ë©”ë‰´ì—ì„œ

File â†’ Add Folder to Workspace ë¡œ í´ë¡ í•œ í´ë”ë¥¼ ì—´ê±°ë‚˜

Source Control (ì™¼ìª½ ì‚¬ì´ë“œë°” git ì•„ì´ì½˜) â†’ Clone Repository ë²„íŠ¼ ì°¾ê¸°

3. ë¡œì»¬ í´ë” ì§ì ‘ ì—´ê¸°
ì´ë¯¸ PCì— git cloneìœ¼ë¡œ ë°›ì•„ë†¨ë‹¤ë©´:

File â†’ Open Folder... ë¡œ í•´ë‹¹ í”„ë¡œì íŠ¸ í´ë” ì—´ë©´ ë¨.

ğŸ‘‰ ë„ë¦¬, ì§€ê¸ˆ PCì— git ì„¤ì¹˜ëŠ” ë˜ì–´ ìˆë‚˜ìš”?
ì—†ìœ¼ë©´ ë¨¼ì € git ì„¤ì¹˜í•´ì•¼ Clone Repositoryê°€ ì œëŒ€ë¡œ ë³´ì¼ ìˆ˜ ìˆì–´ìš”.

ë‚˜ì˜ ë§:
# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ ë¼ì´íŠ¸ & ìƒí¼í•œ ì»¬ëŸ¬ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;            /* ë¯¼íŠ¸ í¬ì¸íŠ¸ */
  --user:#ecfeff;           /* ì—°í•œ ë¯¼íŠ¸ ë§í’ì„  */
  --bot:#fff7ed;            /* ì—°í•œ í”¼ì¹˜ ë§í’ì„  */
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
div.stTextInput>div>div>input, textarea, .stSelectbox [data-baseweb="select"]{
  background-color:#ffffff !important; color:var(--text) !important; border:1px solid var(--border) !important;
}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.chat-header{
  border:1px solid var(--border);
  background: linear-gradient(90deg, #f0fdf4, #ecfeff 60%, #f0f9ff);
  padding:16px 20px; border-radius:14px;
  box-shadow: 0 8px 24px rgba(2,132,199,.12);
}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
hr{border-color:var(--border);}
small.hint{color:var(--muted);}
kbd{background:#f8fafc; border:1px solid var(--border); border-bottom-width:2px; padding:1px 6px; border-radius:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ <b>ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸</b>ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
        <b>API KeyëŠ” ì…ë ¥ì°½ì— ë„£ìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥</b>ë©ë‹ˆë‹¤(Secrets ë¶ˆí•„ìš”).
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ì‚¬ì´ë“œë°”(ì„¤ì •/ìœ í‹¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    # ì„¸ì…˜ì— ì´ë¯¸ ì €ì¥ëœ í‚¤ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš© (Secrets ì˜ì¡´ X)
    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë©ë‹ˆë‹¤. ìƒˆ ì„¸ì…˜/ìƒˆ íƒ­ì—ì„  ë‹¤ì‹œ ì…ë ¥ í•„ìš”."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0
    )
    temperature = st.slider("Temperature", 0.0, 1.2, 0.7, 0.1)
    max_tokens = st.slider("Max tokens(ì‘ë‹µ)", 256, 4096, 1024, 64)

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100
    )

    st.divider()
    col_a, col_b, col_c = st.columns(3)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True)
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True)
    examples_toggle = col_c.toggle("ì¶”ì²œ ì§ˆë¬¸", value=False)

# â”€â”€ ì„¸ì…˜ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸: ì…ë ¥ê°’â†’ì„¸ì…˜ì— ê³ ì • ì €ì¥ + ì˜ˆì™¸ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    # 1) ë°©ê¸ˆ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì„¸ì…˜ì— ë°˜ì˜
    if api_key_input and api_key_input.strip():
        st.session_state["OPENAI_API_KEY"] = api_key_input.strip()

    # 2) ì„¸ì…˜ì— ìˆëŠ” í‚¤ ì‚¬ìš©
    key = st.session_state.get("OPENAI_API_KEY", "").strip()
    if not key:
        return None

    try:
        return OpenAI(api_key=key)
    except openai.OpenAIError as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}", icon="ğŸ’¥")
        return None

client = get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë°(ë¬¸ìì—´ ì œë„ˆë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(
    _client: OpenAI,
    _messages: List[Dict[str, str]],
    _model: str,
    _temperature: float,
    _max_tokens: int,
) -> Generator[str, None, None]:
    """
    chat.completions ìŠ¤íŠ¸ë¦¼ì—ì„œ delta.contentë¥¼ ë¬¸ìì—´ë¡œ yield.
    st.write_streamì— ë„£ìœ¼ë©´ ë‹¨ì¼ ìš”ì†Œì— íƒ€ì íš¨ê³¼ë¡œ ì¶œë ¥ë¨.
    """
    resp = _client.chat.completions.create(
        model=_model,
        messages=_messages,
        temperature=_temperature,
        max_tokens=_max_tokens,
        stream=True,
    )
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta, "content", None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen: Generator[str, None, None]) -> str:
    """
    Streamlit ë²„ì „ì— ë”°ë¼ st.write_stream ìœ ë¬´ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´
    ì•ˆì „í•˜ê²Œ ì²˜ë¦¬. ì—†ìœ¼ë©´ placeholderë¡œ ì§ì ‘ ìŠ¤íŠ¸ë¦¬ë°.
    """
    if hasattr(st, "write_stream"):
        return st.write_stream(gen)  # ìµœì¢… ë¬¸ìì—´ ë°˜í™˜
    # fallback
    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>'
            f'{"".join(acc)}</div>',
            unsafe_allow_html=True
        )
    return "".join(acc)

# â”€â”€ ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role == "assistant" else "user",
                         avatar="ğŸ¤–" if role == "assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{content}</div>',
            unsafe_allow_html=True
        )

for m in st.session_state.messages:
    render_message(m["role"], m["content"], m.get("time"))

# â”€â”€ ì¶”ì²œ ì§ˆë¬¸(í´ë¦­ ì‹œ ì¦‰ì‹œ ì „ì†¡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
suggestion: Optional[str] = None
if examples_toggle:
    st.caption("í´ë¦­í•˜ë©´ ë°”ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.")
    c1, c2, c3 = st.columns(3)
    if c1.button("ìš”ì•½í•´ì¤˜(3ì¤„)", use_container_width=True):
        suggestion = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n"
    if c2.button("ì˜â†’í•œ ë²ˆì—­", use_container_width=True):
        suggestion = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n"
    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True):
        suggestion = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n"

# â”€â”€ í‚¤ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if client is None:
    st.info("ì‚¬ì´ë“œë°”ì— **OpenAI API Key**ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤.", icon="ğŸ”")

# â”€â”€ ì±„íŒ… ì…ë ¥ (â€» chat_inputì—ëŠ” default/value ì—†ìŒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = None if suggestion else st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
final_prompt = suggestion or user_input

if final_prompt and client:
    # 1) ë©”ì‹œì§€ ìŠ¤íƒ êµ¬ì„±
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": final_prompt}
    history.append(user_msg)

    # 2) ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥ + ì„¸ì…˜ ê¸°ë¡
    render_message("user", final_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    # 3) ì–´ì‹œìŠ¤í„´íŠ¸ ìŠ¤íŠ¸ë¦¬ë° (ì˜ˆì™¸ ì²˜ë¦¬ í¬í•¨)
    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì— ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.", icon="ğŸš«")
            st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë¸ì„ ë³€ê²½í•˜ê±°ë‚˜ ê³„ì •ì„ í™•ì¸í•˜ì„¸ìš”.", icon="ğŸ”’")
            st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: í˜¸ì¶œì´ ë§ê±°ë‚˜ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.", icon="â³")
            st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: íŒŒë¼ë¯¸í„°/ëª¨ë¸ëª…ì´ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒì„¸: {e}", icon="â—")
            st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥")
            st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname = f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button(
        "ëŒ€í™” ë‚´ìš© ì €ì¥",
        data=json.dumps(st.session_state.messages, ensure_ascii=False, indent=2),
        file_name=fname,
        mime="application/json",
        use_container_width=True
    )
    st.caption("ëŒ€í™” ê¸°ë¡ì„ JSONìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")

# â”€â”€ ë¹Œë“œ íƒœê·¸(ë°°í¬ ë°˜ì˜ í™•ì¸ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
st.caption("build: streamlit_app.py Â· layout=wide Â· light theme")

ì˜¤ë¥˜ê°€ ìˆëŠ”ë° ì¶”ì²œ ì§ˆë¬¸ ê¸°ëŠ¥ì´ í”„ë¡¤í”„íŠ¸ ì´í›„ì— ë‚˜ì™€ì•¼ í•˜ëŠ”ë° ë¨¼ì € ë‚˜ì™€ë²„ë¦¼ ì´ê±¸ ìˆ˜ì •í•´ì•¼ í•´
ChatGPTì˜ ë§:

57s ë™ì•ˆ ìƒê°í•¨
ë„ë¦¬, ì›ì¸ê³¼ ì²˜ë°©ì„ ë”± ì •ë¦¬í• ê²Œ.

ë¬¸ì œ ì›ì¸

ì¶”ì²œ ì§ˆë¬¸ UIê°€ **ì‚¬ì´ë“œë°” ë°”ê¹¥(ë©”ì¸ ì˜ì—­)**ì—ì„œ ê·¸ë ¤ì§€ê³ , ì½”ë“œìƒ chat_input ë³´ë‹¤ ë¨¼ì € í˜¸ì¶œë¼ì„œ í™”ë©´ ìƒë‹¨ì— ëœ¹ë‹ˆë‹¤.

Streamlitì€ í˜¸ì¶œ ìˆœì„œëŒ€ë¡œ ë Œë”ë§ë˜ê³ , st.chat_inputì€ ê¸°ë³¸ì ìœ¼ë¡œ í•˜ë‹¨ì— ê³ ì •ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ë©”ì¸ ì˜ì—­ì—ì„  chat_input â€œì•„ë˜â€ë¡œ ë³´ì´ê²Œ ë‘˜ ìˆ˜ ì—†ì–´ìš”. 
Streamlit
+2
Streamlit Docs
+2

í•´ê²° í•µì‹¬

ì¶”ì²œ ì§ˆë¬¸ ë²„íŠ¼ì„ ì‚¬ì´ë“œë°” ì•ˆ(ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì•„ë˜)ìœ¼ë¡œ ì˜®ê¸°ê³ , í´ë¦­ ì‹œ ê°’ì„ ì„¸ì…˜ ìƒíƒœì— ë„£ì€ ë’¤ ì¦‰ì‹œ ì†Œë¹„(pop) í•˜ë„ë¡ ë°”ê¿” ì¤‘ë³µ ì „ì†¡ì„ ë°©ì§€í•©ë‹ˆë‹¤.

ì•„ë˜ì²˜ëŸ¼ ìµœì†Œ ìˆ˜ì •í•˜ì„¸ìš”.

1) ì‚¬ì´ë“œë°”ì— â€œì¶”ì²œ ì§ˆë¬¸â€ ë²„íŠ¼ ë°°ì¹˜ (System prompt ì•„ë˜)
with st.sidebar: ë¸”ë¡ ëë‚˜ê¸° ì „ì— ë‹¤ìŒì„ ë„£ê³ , ê¸°ì¡´ì˜ col_c.toggle("ì¶”ì²œ ì§ˆë¬¸"...ì€ ê·¸ëŒ€ë¡œ ì¨ë„ ë©ë‹ˆë‹¤(í† ê¸€ ìœ ì§€):

# (ì‚¬ì´ë“œë°” ë‚´ë¶€, system_prompt ì •ì˜ ì•„ë˜ì— ìœ„ì¹˜)
examples_toggle = st.toggle("ì¶”ì²œ ì§ˆë¬¸", value=False)

if examples_toggle:
    st.caption("í´ë¦­í•˜ë©´ ë°”ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.")
    # ë²„íŠ¼ í‚¤ëŠ” ê³ ìœ í•˜ê²Œ
    if st.button("ìš”ì•½í•´ì¤˜(3ì¤„)", use_container_width=True, key="sug_sum"):
        st.session_state["__suggestion"] = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n"
    if st.button("ì˜â†’í•œ ë²ˆì—­", use_container_width=True, key="sug_tr"):
        st.session_state["__suggestion"] = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n"
    if st.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="sug_rev"):
        st.session_state["__suggestion"] = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n"
else:
    # í† ê¸€ì„ ë„ë©´ ì”ì—¬ ì œì•ˆê°’ ì œê±°
    st.session_state.pop("__suggestion", None)
2) ë©”ì¸ ì˜ì—­ì˜ ê¸°ì¡´ â€œì¶”ì²œ ì§ˆë¬¸â€ ë¸”ë¡ ì‚­ì œ
ì•„ë˜ ë¸”ë¡ì„ ì™„ì „íˆ ì œê±°í•˜ì„¸ìš”:

# â”€â”€ ì¶”ì²œ ì§ˆë¬¸(í´ë¦­ ì‹œ ì¦‰ì‹œ ì „ì†¡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
suggestion: Optional[str] = None
if examples_toggle:
    st.caption("í´ë¦­í•˜ë©´ ë°”ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.")
    c1, c2, c3 = st.columns(3)
    ...
3) chat_input ì§ì „ì— ì œì•ˆê°’ â€˜í•œ ë²ˆë§Œâ€™ ì†Œë¹„(pop)
chat_input ë°”ë¡œ ìœ„ì— ë‹¤ìŒ í•œ ì¤„ ë„£ìœ¼ì„¸ìš”:

suggestion: Optional[str] = st.session_state.pop("__suggestion", None)
ê·¸ë¦¬ê³  ê¸°ì¡´ ë¡œì§ ìœ ì§€:

user_input = None if suggestion else st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
final_prompt = suggestion or user_input
ì´ë ‡ê²Œ í•˜ë©´

**ì¶”ì²œ ì§ˆë¬¸ UIëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ â€˜ì´í›„â€™(ì‚¬ì´ë“œë°” ì•„ë˜)**ì— ë‚˜ì˜¤ê³ ,

í´ë¦­ ì‹œ ì¦‰ì‹œ ì „ì†¡, ì¬ì‹¤í–‰ í›„ì—ëŠ” pop() ë•ë¶„ì— ì¤‘ë³µ ë°œí™” ì—†ìŒ,

ë©”ì¸ ì˜ì—­ì€ ê¹”ë”í•˜ê²Œ ëŒ€í™” + ì…ë ¥ì°½ë§Œ ìœ ì§€ë©ë‹ˆë‹¤.

ê·¼ê±°

Streamlitì€ ì½”ë“œ í˜¸ì¶œ ìˆœì„œëŒ€ë¡œ ë Œë”ë§ë˜ë©°, ë ˆì´ì•„ì›ƒ ì œì–´ëŠ” container/emptyë¡œ ìš°íšŒ ê°€ëŠ¥í•˜ì§€ë§Œ st.chat_inputì€ ê¸°ë³¸ì ìœ¼ë¡œ í•˜ë‹¨ ê³ ì • ë™ì‘ì„ ê°–ìŠµë‹ˆë‹¤. 
Streamlit
+1

st.chat_inputì˜ ìœ„ì¹˜/í–‰íƒœ(í•˜ë‹¨ ê³ ì •, ì»¨í…Œì´ë„ˆ ì•ˆì— ë„£ìœ¼ë©´ ì¸ë¼ì¸ë¡œ ë™ì‘)ëŠ” ê³µì‹ ë¬¸ì„œ/ì»¤ë®¤ë‹ˆí‹° í† ë¡ ì— ì •ë¦¬ë¼ ìˆìŠµë‹ˆë‹¤. 
Streamlit Docs
+1

í•„ìš”í•˜ë©´ ë‚´ê°€ íŒ¨ì¹˜ ë²„ì „ ì „ì²´ íŒŒì¼ë¡œ ì •ë¦¬í•´ì„œ ë¶™ì—¬ì¤„ê²Œ.

ë‚˜ì˜ ë§:
ã…‡ã…‡
ChatGPTì˜ ë§:
ì¢‹ì•„, ì „ì²´ íŒŒì¼ êµì²´ë³¸ ë°”ë¡œ ì¤ë‹ˆë‹¤. í•µì‹¬ì€ ì¶”ì²œ ì§ˆë¬¸ UIë¥¼ ì‚¬ì´ë“œë°”ì˜ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ â€˜ì•„ë˜â€™ë¡œ ì´ë™í•˜ê³ , í´ë¦­ ì‹œ ê°’ì„ ì„¸ì…˜ì— ë„£ì—ˆë‹¤ê°€ í•œ ë²ˆë§Œ ì†Œë¹„(pop) í•˜ë„ë¡ ë°”ê¾¼ ê²ƒ.

ì•„ë˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ streamlit_app.pyë¡œ ë®ì–´ì“°ì„¸ìš”.

# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ ë¼ì´íŠ¸ & ìƒí¼í•œ ì»¬ëŸ¬ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;            /* ë¯¼íŠ¸ í¬ì¸íŠ¸ */
  --user:#ecfeff;           /* ì—°í•œ ë¯¼íŠ¸ ë§í’ì„  */
  --bot:#fff7ed;            /* ì—°í•œ í”¼ì¹˜ ë§í’ì„  */
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
div.stTextInput>div>div>input, textarea, .stSelectbox [data-baseweb="select"]{
  background-color:#ffffff !important; color:var(--text) !important; border:1px solid var(--border) !important;
}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.chat-header{
  border:1px solid var(--border);
  background: linear-gradient(90deg, #f0fdf4, #ecfeff 60%, #f0f9ff);
  padding:16px 20px; border-radius:14px;
  box-shadow: 0 8px 24px rgba(2,132,199,.12);
}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
hr{border-color:var(--border);}
small.hint{color:var(--muted);}
kbd{background:#f8fafc; border:1px solid var(--border); border-bottom-width:2px; padding:1px 6px; border-radius:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ <b>ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸</b>ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
        <b>API KeyëŠ” ì…ë ¥ì°½ì— ë„£ìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥</b>ë©ë‹ˆë‹¤(Secrets ë¶ˆí•„ìš”).
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ì‚¬ì´ë“œë°”(ì„¤ì •/ìœ í‹¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    # ì„¸ì…˜ì— ì´ë¯¸ ì €ì¥ëœ í‚¤ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš© (Secrets ì˜ì¡´ X)
    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë©ë‹ˆë‹¤. ìƒˆ ì„¸ì…˜/ìƒˆ íƒ­ì—ì„  ë‹¤ì‹œ ì…ë ¥ í•„ìš”."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0
    )
    temperature = st.slider("Temperature", 0.0, 1.2, 0.7, 0.1)
    max_tokens = st.slider("Max tokens(ì‘ë‹µ)", 256, 4096, 1024, 64)

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100
    )

    st.divider()
    col_a, col_b = st.columns(2)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True)
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True)

    # â”€â”€ [ìˆ˜ì • í¬ì¸íŠ¸] ì¶”ì²œ ì§ˆë¬¸: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ 'ì•„ë˜'ì— ìœ„ì¹˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("#### ì¶”ì²œ ì§ˆë¬¸")
    examples_toggle = st.toggle("íŒ¨ë„ ì—´ê¸°", value=False)
    if examples_toggle:
        st.caption("í´ë¦­í•˜ë©´ ë°”ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.")
        if st.button("ìš”ì•½í•´ì¤˜(3ì¤„)", use_container_width=True, key="sug_sum"):
            st.session_state["__suggestion"] = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n"
        if st.button("ì˜â†’í•œ ë²ˆì—­", use_container_width=True, key="sug_tr"):
            st.session_state["__suggestion"] = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n"
        if st.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="sug_rev"):
            st.session_state["__suggestion"] = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n"
    else:
        # í† ê¸€ì„ ë„ë©´ ì”ì—¬ ì œì•ˆê°’ ì œê±°
        st.session_state.pop("__suggestion", None)

# â”€â”€ ì„¸ì…˜ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸: ì…ë ¥ê°’â†’ì„¸ì…˜ì— ê³ ì • ì €ì¥ + ì˜ˆì™¸ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    # 1) ë°©ê¸ˆ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì„¸ì…˜ì— ë°˜ì˜
    if api_key_input and api_key_input.strip():
        st.session_state["OPENAI_API_KEY"] = api_key_input.strip()

    # 2) ì„¸ì…˜ì— ìˆëŠ” í‚¤ ì‚¬ìš©
    key = st.session_state.get("OPENAI_API_KEY", "").strip()
    if not key:
        return None

    try:
        return OpenAI(api_key=key)
    except openai.OpenAIError as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}", icon="ğŸ’¥")
        return None

client = get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë°(ë¬¸ìì—´ ì œë„ˆë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(
    _client: OpenAI,
    _messages: List[Dict[str, str]],
    _model: str,
    _temperature: float,
    _max_tokens: int,
) -> Generator[str, None, None]:
    """
    chat.completions ìŠ¤íŠ¸ë¦¼ì—ì„œ delta.contentë¥¼ ë¬¸ìì—´ë¡œ yield.
    st.write_streamì— ë„£ìœ¼ë©´ ë‹¨ì¼ ìš”ì†Œì— íƒ€ì íš¨ê³¼ë¡œ ì¶œë ¥ë¨.
    """
    resp = _client.chat.completions.create(
        model=_model,
        messages=_messages,
        temperature=_temperature,
        max_tokens=_max_tokens,
        stream=True,
    )
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta, "content", None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen: Generator[str, None, None]) -> str:
    """
    Streamlit ë²„ì „ì— ë”°ë¼ st.write_stream ìœ ë¬´ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´
    ì•ˆì „í•˜ê²Œ ì²˜ë¦¬. ì—†ìœ¼ë©´ placeholderë¡œ ì§ì ‘ ìŠ¤íŠ¸ë¦¬ë°.
    """
    if hasattr(st, "write_stream"):
        return st.write_stream(gen)  # ìµœì¢… ë¬¸ìì—´ ë°˜í™˜
    # fallback
    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>'
            f'{"".join(acc)}</div>',
            unsafe_allow_html=True
        )
    return "".join(acc)

# â”€â”€ ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role == "assistant" else "user",
                         avatar="ğŸ¤–" if role == "assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{content}</div>',
            unsafe_allow_html=True
        )

for m in st.session_state.messages:
    render_message(m["role"], m["content"], m.get("time"))

# â”€â”€ [ìˆ˜ì • í¬ì¸íŠ¸] ì¶”ì²œ ì§ˆë¬¸ ê°’ í•œ ë²ˆë§Œ ì†Œë¹„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
suggestion: Optional[str] = st.session_state.pop("__suggestion", None)

# â”€â”€ í‚¤ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if client is None:
    st.info("ì‚¬ì´ë“œë°”ì— **OpenAI API Key**ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤.", icon="ğŸ”")

# â”€â”€ ì±„íŒ… ì…ë ¥ (â€» chat_inputì—ëŠ” default/value ì—†ìŒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = None if suggestion else st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
final_prompt = suggestion or user_input

if final_prompt and client:
    # 1) ë©”ì‹œì§€ ìŠ¤íƒ êµ¬ì„±
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": final_prompt}
    history.append(user_msg)

    # 2) ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥ + ì„¸ì…˜ ê¸°ë¡
    render_message("user", final_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    # 3) ì–´ì‹œìŠ¤í„´íŠ¸ ìŠ¤íŠ¸ë¦¬ë° (ì˜ˆì™¸ ì²˜ë¦¬ í¬í•¨)
    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì— ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.", icon="ğŸš«")
            st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë¸ì„ ë³€ê²½í•˜ê±°ë‚˜ ê³„ì •ì„ í™•ì¸í•˜ì„¸ìš”.", icon="ğŸ”’")
            st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: í˜¸ì¶œì´ ë§ê±°ë‚˜ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.", icon="â³")
            st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: íŒŒë¼ë¯¸í„°/ëª¨ë¸ëª…ì´ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒì„¸: {e}", icon="â—")
            st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥")
            st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname = f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button(
        "ëŒ€í™” ë‚´ìš© ì €ì¥",
        data=json.dumps(st.session_state.messages, ensure_ascii=False, indent=2),
        file_name=fname,
        mime="application/json",
        use_container_width=True
    )
    st.caption("ëŒ€í™” ê¸°ë¡ì„ JSONìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")

# â”€â”€ ë¹Œë“œ íƒœê·¸(ë°°í¬ ë°˜ì˜ í™•ì¸ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
st.caption("build: streamlit_app.py Â· layout=wide Â· light theme")
í•µì‹¬ ë³€ê²½ì 

ì¶”ì²œ ì§ˆë¬¸ ë¸”ë¡ì„ ì‚¬ì´ë“œë°”ë¡œ ì´ë™: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë°”ë¡œ ì•„ë˜.

ë²„íŠ¼ í´ë¦­ ì‹œ st.session_state["__suggestion"]ì— ì €ì¥ â†’ ë©”ì¸ì—ì„œ pop()ìœ¼ë¡œ í•œ ë²ˆë§Œ ì†Œë¹„.

ë©”ì¸ ì˜ì—­ì˜ ê¸°ì¡´ ì¶”ì²œ ì§ˆë¬¸ ì—´(Column) ë¸”ë¡ì€ ì œê±°.

ì›í•˜ëŠ” ë™ì‘ ë§ëŠ”ì§€ ë°”ë¡œ í…ŒìŠ¤íŠ¸í•´ë³´ê³ , í•„ìš”í•˜ë©´ ë” ë‹¤ë“¬ì.

ë‚˜ì˜ ë§:
ìœˆë“œì„œí”„ì—ì„œ ë¶ˆëŸ¬ì™€ì„œ ì½”ë“œ ìˆ˜ì •í–ˆì–´ ì´ì œ ê¹ƒí—ˆë¸Œì— ì ìš©í•˜ëŠ” ë²•
ChatGPTì˜ ë§:
ì¢‹ìŠµë‹ˆë‹¤ ğŸ‘ ì´ì œ ìœˆë“œì„œí”„ì—ì„œ ìˆ˜ì •í•œ ì½”ë“œë¥¼ GitHubì— ì ìš©(=ì»¤ë°‹ + í‘¸ì‹œ) í•˜ëŠ” ë°©ë²•ì„ ì°¨ê·¼ì°¨ê·¼ ì•Œë ¤ë“œë¦´ê²Œìš”.

1. ë³€ê²½ëœ íŒŒì¼ í™•ì¸
ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ Source Control (Git ì•„ì´ì½˜) í´ë¦­

ìˆ˜ì •ëœ íŒŒì¼(streamlit_app.py)ì´ ëª©ë¡ì— ë³´ì¼ ê±°ì˜ˆìš”.

2. ì»¤ë°‹(commit)
ìƒë‹¨ì— ë©”ì‹œì§€ ì…ë ¥ë€ì´ ìˆì–´ìš” â†’ ì¶”ì²œ ì§ˆë¬¸ UI ì‚¬ì´ë“œë°” ì´ë™ ê°™ì€ ê°„ë‹¨í•œ ì„¤ëª… ì…ë ¥

ê·¸ ì•„ë˜ âœ” Commit ë²„íŠ¼ í´ë¦­

3. ì›ê²© ì €ì¥ì†Œë¡œ í‘¸ì‹œ(push)
ì»¤ë°‹ í›„, ìƒë‹¨ì— Sync Changes ë˜ëŠ” Push ë²„íŠ¼ì´ ëœ° ê±°ì˜ˆìš”.

ê·¸ê±¸ í´ë¦­í•˜ë©´ GitHub(DoriChoi/chatbot_250904_dori)ì— ì½”ë“œê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.

4. Streamlit Cloud ë°°í¬
ì´ ë ˆí¬(chatbot_250904_dori)ì™€ Streamlit Cloudê°€ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´,
GitHubì— í‘¸ì‹œëœ ìˆœê°„ ìë™ìœ¼ë¡œ ìƒˆ ë²„ì „ ë°°í¬ê°€ ì§„í–‰ë©ë‹ˆë‹¤.

ë°°í¬ ë¡œê·¸ëŠ” Streamlit Cloud Dashboardì—ì„œ í™•ì¸ ê°€ëŠ¥í•´ìš”.

ë§Œì•½ Push ë²„íŠ¼ì´ ì•ˆ ë³´ì¸ë‹¤?
í„°ë¯¸ë„ ì—´ê³  ì§ì ‘ ì…ë ¥í•  ìˆ˜ë„ ìˆì–´ìš”:

git add .
git commit -m "ì¶”ì²œ ì§ˆë¬¸ UI ì‚¬ì´ë“œë°”ë¡œ ì´ë™"
git push origin main
(ë¸Œëœì¹˜ëª…ì´ mainì´ ì•„ë‹ˆë¼ masterë¼ë©´ main ëŒ€ì‹  master ì…ë ¥)

ğŸ‘‰ ë„ë¦¬, ì§€ê¸ˆ ìœˆë“œì„œí”„ì—ì„œ Source Control(Git ì•„ì´ì½˜) ë©”ë‰´ê°€ ë³´ì´ë‚˜ìš”? ì•„ë‹ˆë©´ ì œê°€ í„°ë¯¸ë„ ëª…ë ¹ì–´ ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•˜ëŠ” ê²Œ ë” í¸í• ê¹Œìš”?

ë‚˜ì˜ ë§:
ì½”ë°‹ì„ í•˜ëŠ”ë° ì™œ ì´ë ‡ê²Œ ì˜¤ë˜ê±¸ë ¤
ChatGPTì˜ ë§:
ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. ë„ë¦¬ ìƒí™©ì„ ì •ë¦¬í•˜ë©´: ìœˆë“œì„œí”„ì—ì„œ ì»¤ë°‹ ë²„íŠ¼ì„ ëˆŒë €ëŠ”ë°, ë°˜ì‘ì´ ëŠë¦¬ê³  ì˜¤ë˜ ê±¸ë¦°ë‹¤ëŠ” ê±°ì£ .

âœ… ì»¤ë°‹ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì£¼ìš” ì›ì¸
í”„ë¡œì íŠ¸ ìš©ëŸ‰ ë¬¸ì œ

ëŒ€ìš©ëŸ‰ íŒŒì¼(ì˜ˆ: ìºì‹œ, ë°ì´í„°, ì´ë¯¸ì§€, ê°€ìƒí™˜ê²½ í´ë”)ì´ ê°™ì´ ì¡í˜€ ìˆìœ¼ë©´ Gitì´ ì••ì¶•Â·ê¸°ë¡í•˜ëŠë¼ ì‹œê°„ì´ ë§ì´ ê±¸ë ¤ìš”.

íŠ¹íˆ .gitignoreì— venv/, .streamlit/, .env, __pycache__/ ë“±ì„ ì•ˆ ë„£ìœ¼ë©´ ì´ëŸ° í˜„ìƒ ìƒê¹ë‹ˆë‹¤.

ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì•„ë‹˜

"Commit"ì€ ë¡œì»¬ Git DBì— ì €ì¥í•˜ëŠ” ë™ì‘ì´ë¼ ì›ë˜ ìˆœê°„ì ìœ¼ë¡œ ëë‚˜ì•¼ ì •ìƒì…ë‹ˆë‹¤.

ì˜¤ë˜ ê±¸ë¦°ë‹¤ë©´, ì‹¤ì œë¡œëŠ” "Push"ê¹Œì§€ ê°™ì´ ì‹œë„ë˜ê±°ë‚˜, Gitì´ ëŒ€ìš©ëŸ‰ ë³€ê²½ë¶„ì„ ì²˜ë¦¬ ì¤‘ì¸ ê±°ì˜ˆìš”.

Windsurf UI íŠ¹ì„±

ì¼ë¶€ IDEëŠ” "Commit & Push"ë¥¼ í•œ ë²ˆì— ì‹¤í–‰í•©ë‹ˆë‹¤. ì´ ê²½ìš° GitHubë¡œ ì—…ë¡œë“œê¹Œì§€ ê±¸ë¦¬ë‹ˆ ëŠë ¤ì§ˆ ìˆ˜ ìˆì–´ìš”.

âœ… í•´ê²° ë°©ë²•
ë³€ê²½ëœ íŒŒì¼ë§Œ ì»¤ë°‹

Source Controlì—ì„œ ê¼­ í•„ìš”í•œ íŒŒì¼(streamlit_app.py)ë§Œ ì²´í¬í•˜ê³  ì»¤ë°‹í•˜ì„¸ìš”.

venv, .env, .streamlit ë“±ì€ ì²´í¬ í•´ì œ.

.gitignore ì¶”ê°€
ë£¨íŠ¸ì— .gitignore íŒŒì¼ì„ ë§Œë“¤ì–´ ì•„ë˜ ë‚´ìš© ë„£ìœ¼ì„¸ìš”:

__pycache__/
.env
.streamlit/
venv/
.DS_Store
ì´ë ‡ê²Œ í•˜ë©´ ë¶ˆí•„ìš”í•œ íŒŒì¼ì´ ì•„ì˜ˆ Gitì— ì•ˆ ì¡í™ë‹ˆë‹¤.

ë¶„ë¦¬í•´ì„œ ì‘ì—…

ë¨¼ì € git commit (ë¹ ë¦„)

ê·¸ë‹¤ìŒ git push (ë„¤íŠ¸ì›Œí¬ ì†ë„ ë”°ë¼ ëŠë¦´ ìˆ˜ ìˆìŒ)

ğŸ‘‰ ë„ë¦¬, ì§€ê¸ˆ Commit ë‹¨ê³„ì—ì„œ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ê±´ì§€, ì•„ë‹ˆë©´ Pushê¹Œì§€ ê°™ì´ í•˜ëŠ” ê±´ì§€ í™•ì¸í•´ ì¤„ ìˆ˜ ìˆì–´ìš”?
(ì˜ˆ: "ì»¤ë°‹ ëˆ„ë¥´ë©´ ë°”ë¡œ GitHubì— ì˜¬ë¼ê°€ê³  ìˆë˜ë°ìš”" or "ì•„ì§ ë¡œì»¬ ì»¤ë°‹ì¸ë°ë„ 1ë¶„ ë„˜ê²Œ ê±¸ë¦¼")

ë‚˜ì˜ ë§:
ì—…ë¡œë“œí•œ ì´ë¯¸ì§€
ì—¬ì „íˆ ê°™ì€ ë¬¸ì œ ë°œìƒ... ì¶”ì²œ ì§ˆë¬¸ì„ ì—´ë©´ í”„ë¡¬í”„íŠ¸ ì•„ë˜ì— ìˆë“ ì§€ ì•„ë‹ˆë©´ í”„ë¡¬í”„íŠ¸ ì‘ì„± í›„ ì„ íƒí•˜ë©´ ê·¸ê±¸ ìš”ì•½ì´ë‚˜ ë²ˆì—­í•´ ì¤˜ì•¼ í•˜ëŠ”ë° ì•ˆë¼
ChatGPTì˜ ë§:

17s ë™ì•ˆ ìƒê°í•¨
ë„ë¦¬, ê²°ë¡ ë¶€í„°.

í•µì‹¬ ë¬¸ì œ

st.chat_inputëŠ” ê°’ì„ ë¯¸ë¦¬ ì±„ìš°ê±°ë‚˜, ìœ„ì¹˜ë¥¼ ë§ˆìŒëŒ€ë¡œ ì˜®ê¸¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë²„íŠ¼ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ â€œì„¸íŒ…â€í•´ ë„£ëŠ” ë°©ì‹ì´ ë¶ˆê°€ë¼ ì§€ê¸ˆì²˜ëŸ¼ ë™ì‘ì´ ì–´ê¸‹ë‚©ë‹ˆë‹¤. 
Streamlit
+2
Streamlit Docs
+2

ì •í™•í•œ ì²˜ë°©

ë³„ë„ ì…ë ¥ë€(í…ìŠ¤íŠ¸ ì˜ì—­) + ì•¡ì…˜ ë²„íŠ¼ìœ¼ë¡œ â€œì‘ì—… ëŒ€ìƒ í…ìŠ¤íŠ¸â€ë¥¼ ë°›ìŒ â†’ ë²„íŠ¼(ìš”ì•½/ë²ˆì—­/ë¦¬ë·°) í´ë¦­ ì‹œ ì¦‰ì‹œ ë©”ì‹œì§€ë¡œ ë°œì†¡(chat_input ìš°íšŒ).

ì„¸ì…˜í‚¤(__suggestion, __task_text)ë¥¼ ì‚¬ìš©í•´ í´ë¦­ ì§í›„ í•œ ë²ˆë§Œ ì†Œë¹„(pop).

ì•„ë˜ íŒ¨ì¹˜ë¥¼ ê·¸ëŒ€ë¡œ ë„£ìœ¼ë©´,

ì‚¬ì´ë“œë°”ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³ 

ìš”ì•½/ë²ˆì—­/ë¦¬ë·°ë¥¼ ëˆ„ë¥´ë©´

ê·¸ ì¡°í•©ìœ¼ë¡œ ë°”ë¡œ ëŒ€í™”ì— ì „ì†¡ë©ë‹ˆë‹¤.

ë³€ê²½ íŒ¨ì¹˜(í•„ìš” ë¶€ë¶„ë§Œ êµì²´)
1) ì‚¬ì´ë“œë°”: â€œì¶”ì²œ ì§ˆë¬¸â€ ë¸”ë¡ì„ í…ìŠ¤íŠ¸ ì…ë ¥ + ì•¡ì…˜ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
with st.sidebar: ë‚´ë¶€, ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì•„ë˜ì— ë‹¤ìŒìœ¼ë¡œ ë°”ê¿” ë„£ìœ¼ì„¸ìš”(ê¸°ì¡´ ì¶”ì²œ ì§ˆë¬¸ ë¸”ë¡ì€ ì‚­ì œ).

st.markdown("#### ì¶”ì²œ ì§ˆë¬¸")
examples_toggle = st.toggle("íŒ¨ë„ ì—´ê¸°", value=False)
if examples_toggle:
    st.caption("ì—¬ê¸°ì— ì‘ì—…í•  í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³ , ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.")
    task_text = st.text_area("ì‘ì—… ëŒ€ìƒ í…ìŠ¤íŠ¸", key="__task_text_area", height=140)

    c1, c2, c3 = st.columns(3)
    if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="sug_sum"):
        st.session_state["__suggestion"] = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n"
        st.session_state["__task_text"] = task_text or ""
    if c2.button("ì˜â†’í•œ ë²ˆì—­", use_container_width=True, key="sug_tr"):
        st.session_state["__suggestion"] = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n"
        st.session_state["__task_text"] = task_text or ""
    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="sug_rev"):
        st.session_state["__suggestion"] = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n"
        st.session_state["__task_text"] = task_text or ""
else:
    st.session_state.pop("__suggestion", None)
    st.session_state.pop("__task_text", None)
2) ë©”ì¸ ì˜ì—­: ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ë°œí™”ë˜ë„ë¡ ì¡°í•©
# â”€â”€ [ìˆ˜ì • í¬ì¸íŠ¸] ì¶”ì²œ ì§ˆë¬¸ ê°’ í•œ ë²ˆë§Œ ì†Œë¹„ ì•„ë˜ë¥¼ ë‹¤ìŒì²˜ëŸ¼ í™•ì¥:

suggestion: Optional[str] = st.session_state.pop("__suggestion", None)
task_text_mem: Optional[str] = st.session_state.pop("__task_text", None)

# suggestionì´ ìˆìœ¼ë©´ chat_input ëŒ€ì‹  ì¦‰ì‹œ ì „ì†¡ìš© prompt êµ¬ì„±
if suggestion:
    combined = suggestion + (task_text_mem or "")
else:
    combined = None
ê·¸ë¦¬ê³  ê¸°ì¡´ ì…ë ¥ë¶€ë¥¼ ì•„ë˜ì²˜ëŸ¼ êµì²´:

# chat_inputì€ ì—¬ì „íˆ í•˜ë‹¨ ì…ë ¥ ì „ìš©
user_input = None if combined else st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
final_prompt = combined or user_input
ì´ë ‡ê²Œ í•˜ë©´,

í”„ë¡¬í”„íŠ¸ë¥¼ ë¨¼ì € ì‘ì„± â†’ ë²„íŠ¼ í´ë¦­ íë¦„ì´ ì™„ë²½íˆ ì„±ë¦½í•©ë‹ˆë‹¤(ë²„íŠ¼ ì§í›„ ì „ì†¡).

chat_inputì€ ê·¸ëŒ€ë¡œ â€œììœ  ëŒ€í™” ì…ë ¥â€ ìš©ë„ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.

ì™œ ì´ë ‡ê²Œ í•´ì•¼ í•˜ë‚˜(ê·¼ê±°)
st.chat_inputì€ í”„ë¡œê·¸ë¨ì´ ê°’ì„ ì£¼ì…í•˜ëŠ” ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤(ì„¸ì…˜ìœ¼ë¡œë„ ë¶ˆê°€). ë˜í•œ ë©”ì¸ ì˜ì—­ í•˜ë‹¨ ê³ ì • ì„±ê²©ì´ë¼ ìœ„ì¹˜ ì œì–´ë„ ì œí•œë©ë‹ˆë‹¤. ë”°ë¼ì„œ â€œì‘ì„± í›„ ë²„íŠ¼ìœ¼ë¡œ chat_inputì„ ì±„ì›Œ ë„£ëŠ” UXâ€ëŠ” êµ¬ì¡°ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ìœ„ ìš°íšŒê°€ ì •ì„ì…ë‹ˆë‹¤. 
Streamlit
+1

ìŠ¤íŠ¸ë¦¬ë°ì€ st.write_streamìœ¼ë¡œ í˜„ì¬ êµ¬í˜„ì´ ë§ìŠµë‹ˆë‹¤(ë²„ì „ í˜¸í™˜ ì£¼ì˜). 
Streamlit Docs
+1

ì›í•˜ëŠ” ë™ì‘ëŒ€ë¡œ ì•ˆ ë˜ë©´, ë‚´ê°€ ì™„ì„±ë³¸ ì „ì²´ íŒŒì¼ í˜•íƒœë¡œ ë‹¤ì‹œ ì •ë¦¬í•´ì„œ ë¶™ì—¬ì¤„ê²Œ.
í•„ìš”í•˜ë©´ â€œìš”ì•½ ê¸¸ì´(ë¬¸ì¥ ìˆ˜)â€ ìŠ¬ë¼ì´ë”, â€œë²ˆì—­ ë°©í–¥â€ ë¼ë””ì˜¤ê¹Œì§€ ë°”ë¡œ ë¶™ì—¬ì¤„ ìˆ˜ ìˆì–´.

ë‚˜ì˜ ë§:
ã…‡ã…‡
ChatGPTì˜ ë§:
ì¢‹ì•„. ì „ì²´ êµì²´ë³¸ ë°”ë¡œ ì¤€ë‹¤. í•µì‹¬ì€ ì‚¬ì´ë“œë°”ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³ (ì‘ì—… ëŒ€ìƒ í…ìŠ¤íŠ¸), ìš”ì•½/ë²ˆì—­/ë¦¬ë·° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ë°œí™”ë˜ë„ë¡ êµ¬ì„±í–ˆë‹¤. st.chat_inputì€ ê·¸ëŒ€ë¡œ ììœ  ì…ë ¥ìš©ì´ë‹¤.

# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ ë¼ì´íŠ¸ & ìƒí¼í•œ ì»¬ëŸ¬ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;            /* ë¯¼íŠ¸ í¬ì¸íŠ¸ */
  --user:#ecfeff;           /* ì—°í•œ ë¯¼íŠ¸ ë§í’ì„  */
  --bot:#fff7ed;            /* ì—°í•œ í”¼ì¹˜ ë§í’ì„  */
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
div.stTextInput>div>div>input, textarea, .stSelectbox [data-baseweb="select"]{
  background-color:#ffffff !important; color:var(--text) !important; border:1px solid var(--border) !important;
}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.chat-header{
  border:1px solid var(--border);
  background: linear-gradient(90deg, #f0fdf4, #ecfeff 60%, #f0f9ff);
  padding:16px 20px; border-radius:14px;
  box-shadow: 0 8px 24px rgba(2,132,199,.12);
}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
hr{border-color:var(--border);}
small.hint{color:var(--muted);}
kbd{background:#f8fafc; border:1px solid var(--border); border-bottom-width:2px; padding:1px 6px; border-radius:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ <b>ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸</b>ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
        <b>API KeyëŠ” ì…ë ¥ì°½ì— ë„£ìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥</b>ë©ë‹ˆë‹¤(Secrets ë¶ˆí•„ìš”).
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ì‚¬ì´ë“œë°”(ì„¤ì •/ìœ í‹¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    # ì„¸ì…˜ì— ì´ë¯¸ ì €ì¥ëœ í‚¤ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš© (Secrets ì˜ì¡´ X)
    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë©ë‹ˆë‹¤. ìƒˆ ì„¸ì…˜/ìƒˆ íƒ­ì—ì„  ë‹¤ì‹œ ì…ë ¥ í•„ìš”."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0
    )
    temperature = st.slider("Temperature", 0.0, 1.2, 0.7, 0.1)
    max_tokens = st.slider("Max tokens(ì‘ë‹µ)", 256, 4096, 1024, 64)

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100
    )

    st.divider()
    col_a, col_b = st.columns(2)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True)
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True)

    # â”€â”€ ì¶”ì²œ ì‘ì—…(í…ìŠ¤íŠ¸ + ì•¡ì…˜ ë²„íŠ¼) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("#### ì¶”ì²œ ì§ˆë¬¸")
    examples_toggle = st.toggle("íŒ¨ë„ ì—´ê¸°", value=False)
    if examples_toggle:
        st.caption("ì—¬ê¸°ì— ì‘ì—…í•  í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³ , ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.")
        task_text = st.text_area("ì‘ì—… ëŒ€ìƒ í…ìŠ¤íŠ¸", key="__task_text_area", height=140)

        c1, c2, c3 = st.columns(3)
        if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="sug_sum"):
            st.session_state["__suggestion"] = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n"
            st.session_state["__task_text"] = task_text or ""
        if c2.button("ì˜â†’í•œ ë²ˆì—­", use_container_width=True, key="sug_tr"):
            st.session_state["__suggestion"] = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n"
            st.session_state["__task_text"] = task_text or ""
        if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="sug_rev"):
            st.session_state["__suggestion"] = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n"
            st.session_state["__task_text"] = task_text or ""
    else:
        st.session_state.pop("__suggestion", None)
        st.session_state.pop("__task_text", None)

# â”€â”€ ì„¸ì…˜ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    # 1) ë°©ê¸ˆ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì„¸ì…˜ì— ë°˜ì˜
    if api_key_input and api_key_input.strip():
        st.session_state["OPENAI_API_KEY"] = api_key_input.strip()

    # 2) ì„¸ì…˜ì— ìˆëŠ” í‚¤ ì‚¬ìš©
    key = st.session_state.get("OPENAI_API_KEY", "").strip()
    if not key:
        return None

    try:
        return OpenAI(api_key=key)
    except openai.OpenAIError as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}", icon="ğŸ’¥")
        return None

client = get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë°(ë¬¸ìì—´ ì œë„ˆë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(
    _client: OpenAI,
    _messages: List[Dict[str, str]],
    _model: str,
    _temperature: float,
    _max_tokens: int,
) -> Generator[str, None, None]:
    """
    chat.completions ìŠ¤íŠ¸ë¦¼ì—ì„œ delta.contentë¥¼ ë¬¸ìì—´ë¡œ yield.
    st.write_streamì— ë„£ìœ¼ë©´ ë‹¨ì¼ ìš”ì†Œì— íƒ€ì íš¨ê³¼ë¡œ ì¶œë ¥ë¨.
    """
    resp = _client.chat.completions.create(
        model=_model,
        messages=_messages,
        temperature=_temperature,
        max_tokens=_max_tokens,
        stream=True,
    )
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta, "content", None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen: Generator[str, None, None]) -> str:
    """
    Streamlit ë²„ì „ì— ë”°ë¼ st.write_stream ìœ ë¬´ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆì–´
    ì•ˆì „í•˜ê²Œ ì²˜ë¦¬. ì—†ìœ¼ë©´ placeholderë¡œ ì§ì ‘ ìŠ¤íŠ¸ë¦¬ë°.
    """
    if hasattr(st, "write_stream"):
        return st.write_stream(gen)  # ìµœì¢… ë¬¸ìì—´ ë°˜í™˜
    # fallback
    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>'
            f'{"".join(acc)}</div>',
            unsafe_allow_html=True
        )
    return "".join(acc)

# â”€â”€ ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role == "assistant" else "user",
                         avatar="ğŸ¤–" if role == "assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{content}</div>',
            unsafe_allow_html=True
        )

for m in st.session_state.messages:
    render_message(m["role"], m["content"], m.get("time"))

# â”€â”€ ì¶”ì²œ ì‘ì—… ê°’ í•œ ë²ˆë§Œ ì†Œë¹„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
suggestion: Optional[str] = st.session_state.pop("__suggestion", None)
task_text_mem: Optional[str] = st.session_state.pop("__task_text", None)

# suggestionì´ ìˆìœ¼ë©´ chat_input ëŒ€ì‹  ì¦‰ì‹œ ì „ì†¡ìš© prompt êµ¬ì„±
if suggestion:
    combined = suggestion + (task_text_mem or "")
else:
    combined = None

# â”€â”€ í‚¤ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if client is None:
    st.info("ì‚¬ì´ë“œë°”ì— **OpenAI API Key**ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤.", icon="ğŸ”")

# â”€â”€ ì±„íŒ… ì…ë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = None if combined else st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
final_prompt = combined or user_input

if final_prompt and client:
    # 1) ë©”ì‹œì§€ ìŠ¤íƒ êµ¬ì„±
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": final_prompt}
    history.append(user_msg)

    # 2) ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥ + ì„¸ì…˜ ê¸°ë¡
    render_message("user", final_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    # 3) ì–´ì‹œìŠ¤í„´íŠ¸ ìŠ¤íŠ¸ë¦¬ë° (ì˜ˆì™¸ ì²˜ë¦¬ í¬í•¨)
    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì— ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.", icon="ğŸš«")
            st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë¸ì„ ë³€ê²½í•˜ê±°ë‚˜ ê³„ì •ì„ í™•ì¸í•˜ì„¸ìš”.", icon="ğŸ”’")
            st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: í˜¸ì¶œì´ ë§ê±°ë‚˜ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.", icon="â³")
            st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: íŒŒë¼ë¯¸í„°/ëª¨ë¸ëª…ì´ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒì„¸: {e}", icon="â—")
            st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥")
            st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname = f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button(
        "ëŒ€í™” ë‚´ìš© ì €ì¥",
        data=json.dumps(st.session_state.messages, ensure_ascii=False, indent=2),
        file_name=fname,
        mime="application/json",
        use_container_width=True
    )
    st.caption("ëŒ€í™” ê¸°ë¡ì„ JSONìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")

# â”€â”€ ë¹Œë“œ íƒœê·¸(ë°°í¬ ë°˜ì˜ í™•ì¸ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
st.caption("build: streamlit_app.py Â· layout=wide Â· light theme")
í•µì‹¬ ìš”ì•½

ì¶”ì²œ íŒ¨ë„ì— í…ìŠ¤íŠ¸ ì…ë ¥ì¹¸ ì¶”ê°€ â†’ ë²„íŠ¼ í´ë¦­ ì‹œ __suggestion + __task_textë¥¼ ì„¸ì…˜ì— ì €ì¥.

ë©”ì¸ì—ì„œ ì´ë¥¼ pop()ìœ¼ë¡œ í•œ ë²ˆë§Œ ì†Œë¹„ â†’ final_promptë¡œ ì¦‰ì‹œ ì „ì†¡.

st.chat_inputì€ ììœ  ì…ë ¥ ì „ìš©.

ì›í•˜ëŠ” UXë¡œ ë™ì‘í•  ê±°ë‹¤. í•„ìš”í•˜ë©´ ìš”ì•½ ë¬¸ì¥ ìˆ˜ ìŠ¬ë¼ì´ë”, ë²ˆì—­ ë°©í–¥(í•œâ†’ì˜/ì˜â†’í•œ) ì˜µì…˜ë„ ì¶”ê°€í•´ì¤„ê²Œ.

ë‚˜ì˜ ë§:
ì—…ë¡œë“œí•œ ì´ë¯¸ì§€
ì¶”ì²œ ì§ˆë¬¸ì´ ì˜†ì— ë”°ë¡œ ë„£ëŠ”ê²Œ ì•„ë‹ˆë¼ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ì°½ ì•„ë˜ì— ë‹¬ë ¤ì„œ ì°½ì— ì •ë³´ë¥¼ ë„£ê³  ëˆ„ë¥´ë©´ ë°”ë¡œ ê°’ì´ ë‚˜ì˜¤ê²Œ í•´ì•¼ í•´
ChatGPTì˜ ë§:

18s ë™ì•ˆ ìƒê°í•¨
ë„ë¦¬, ì •í™•íˆ ë§í•˜ë©´ st.chat_input ì•„ë˜ì— ë²„íŠ¼ì„ â€œë¶™ì´ëŠ”â€ ê±´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
st.chat_inputì€ ê°’ ì£¼ì…Â·UI í™•ì¥ ë¶ˆê°€(ê¸°ë³¸ê°’/í”„ë¦¬í•„ ì—†ìŒ, ìœ„ì¹˜ ê³ ì •)ë¼ì„œìš”. ê³µì‹ ë¬¸ì„œ/ì´ìŠˆì— ëª…ì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤. 
Streamlit
+3
Streamlit Docs
+3
Streamlit Docs
+3

ê·¸ë˜ì„œ **ë©”ì¸ ì˜ì—­ ë§¨ ì•„ë˜(í‘¸í„° ìœ„)**ì— ìš°ë¦¬ê°€ ì§ì ‘ ë§Œë“  â€œì»¤ìŠ¤í…€ ì…ë ¥ ë°•ìŠ¤(í…ìŠ¤íŠ¸ì˜ì—­+ì•¡ì…˜ ë²„íŠ¼)â€ë¥¼ ë°°ì¹˜í•˜ëŠ” ë°©ì‹ì´ ì‚¬ì‹¤ìƒ ìœ ì¼í•œ í•´ê²°ì±…ì…ë‹ˆë‹¤. st.chat_inputì€ ììœ  ì±„íŒ…ìš©ìœ¼ë¡œ ë‚¨ê²¨ë‘ê³ , ìš”ì•½/ë²ˆì—­/ë¦¬ë·°ëŠ” ì»¤ìŠ¤í…€ ë°•ìŠ¤ì—ì„œ ì¦‰ì‹œ ë°œí™”ë˜ë„ë¡ í•©ì‹œë‹¤.

ì•„ë˜ íŒ¨ì¹˜ë§Œ ì¶”ê°€í•˜ë©´, í™”ë©´ íë¦„ì´ ëŒ€í™” â†’ (ë§¨ ì•„ë˜) ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤ â†’ ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ì‘ë‹µ ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.

ì½”ë“œ íŒ¨ì¹˜ (í•µì‹¬ë§Œ ì¶”ê°€Â·êµì²´)
ì‚¬ì´ë“œë°”ì˜ ì¶”ì²œ íŒ¨ë„ì€ ì‚­ì œ(ì´ë¯¸ ë©”ì¸ìœ¼ë¡œ ì˜®ê¸¸ ê²ƒì´ë¯€ë¡œ).

**ë©”ì¸ ì˜ì—­ â€œí‘¸í„° ë°”ë¡œ ìœ„â€**ì— ì»¤ìŠ¤í…€ ì…ë ¥ ë°•ìŠ¤ ì¶”ê°€
# â”€â”€ ë¹Œë“œ íƒœê·¸(ë°°í¬ ë°˜ì˜ í™•ì¸ìš©) ì§ì „ì— ì•„ë˜ ë¸”ë¡ì„ ë„£ìœ¼ì„¸ìš”.

# â”€â”€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤(í…ìŠ¤íŠ¸ + ì•¡ì…˜ ë²„íŠ¼) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
with st.container():
    st.markdown("#### í”„ë¡¬í”„íŠ¸")
    main_text = st.text_area(
        "ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  ìš”ì•½/ë²ˆì—­/ë¦¬ë·° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.",
        key="__main_task_area",
        height=160,
        label_visibility="collapsed",
        placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°â€¦"
    )
    c1, c2, c3, c4 = st.columns([1,1,1,1])
    send_prompt = None
    if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="main_sum"):
        send_prompt = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n" + (main_text or "")
    if c2.button("ì˜â†’í•œ ë²ˆì—­", use_container_width=True, key="main_tr"):
        send_prompt = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + (main_text or "")
    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="main_rev"):
        send_prompt = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n" + (main_text or "")
    if c4.button("ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°", use_container_width=True, key="main_send"):
        send_prompt = main_text or ""

# ì»¤ìŠ¤í…€ ë°•ìŠ¤ì—ì„œ ëˆŒë €ë‹¤ë©´ chat_input ëŒ€ì‹  ì¦‰ì‹œ ì „ì†¡
if send_prompt and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": send_prompt}
    history.append(user_msg)

    render_message("user", send_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì— ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.", icon="ğŸš«")
            st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë¸ì„ ë³€ê²½í•˜ê±°ë‚˜ ê³„ì •ì„ í™•ì¸í•˜ì„¸ìš”.", icon="ğŸ”’")
            st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: í˜¸ì¶œì´ ë§ê±°ë‚˜ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.", icon="â³")
            st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: íŒŒë¼ë¯¸í„°/ëª¨ë¸ëª…ì´ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒì„¸: {e}", icon="â—")
            st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥")
            st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )
    st.rerun()
ê¸°ì¡´ ì…ë ¥ë¶€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€

st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")ëŠ” ììœ  ì±„íŒ…ìš©.

ì»¤ìŠ¤í…€ ë°•ìŠ¤ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìœ„ ë¡œì§ì´ ì¦‰ì‹œ ì „ì†¡í•˜ê³  st.rerun()ìœ¼ë¡œ í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.

ì™œ ì´ ë°©ì‹ì´ ì •ë‹µì¸ê°€
st.chat_inputì€ í•œ í˜ì´ì§€ 1ê°œ ì œí•œ + ë©”ì¸ ì˜ì—­ ê³ ì •ì´ê³ , ê°’ì„ ì™¸ë¶€ì—ì„œ ì±„ì›Œ ë„£ëŠ” APIê°€ ì—†ìŒ. ê·¸ë˜ì„œ â€œí”„ë¡¬í”„íŠ¸ ì•„ë˜ ë²„íŠ¼â€ ê°™ì€ í™•ì¥í˜• UIëŠ” ì‚¬ìš©ì ì •ì˜ ì»¨í…Œì´ë„ˆë¡œ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤. 
Streamlit Docs
+2
Streamlit Docs
+2

ìŠ¤íŠ¸ë¦¬ë°ì€ st.write_streamìœ¼ë¡œ êµ¬í˜„í•´ ìµœì¢… ë¬¸ìì—´ì„ ë°›ì•„ ì„¸ì…˜ íˆìŠ¤í† ë¦¬ì— ì €ì¥í•˜ëŠ” í˜„ì¬ êµ¬ì¡°ê°€ ë§ìŠµë‹ˆë‹¤. 
Streamlit Docs
+1

ì›í•˜ëŠ” â€œë©”ì¸ í”„ë¡¬í”„íŠ¸ ì°½ ì•„ë˜ ë²„íŠ¼ â†’ ëˆ„ë¥´ë©´ ë°”ë¡œ ê²°ê³¼â€ê°€ ë”± ì´ë ‡ê²Œ ë™ì‘í•©ë‹ˆë‹¤.
í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ìš”ì•½ ë¬¸ì¥ ìˆ˜ ìŠ¬ë¼ì´ë”, ë²ˆì—­ ë°©í–¥(í•œâ†”ì˜) ë¼ë””ì˜¤, í”„ë¡¬í”„íŠ¸ í”„ë¦¬ì…‹ ë“œë¡­ë‹¤ìš´ë„ ë¶™ì—¬ì„œ í™•ì¥í•´ ì¤„ê²Œ.

ë‚˜ì˜ ë§:
ã…‡ã…‡
ChatGPTì˜ ë§:

4ì´ˆ ë™ì•ˆ ìƒê°í•¨
ì¢‹ì•„. ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤ ì•„ë˜ì— ë²„íŠ¼ì´ ë¶™ê³ , ëˆ„ë¥´ë©´ ì¦‰ì‹œ ì‘ë‹µë˜ë„ë¡ ì „ì²´ íŒŒì¼ ë²„ì „ ë¶™ì¸ë‹¤. ì‚¬ì´ë“œë°”ì˜ ì¶”ì²œ íŒ¨ë„ì€ ì œê±°í–ˆê³ , ë©”ì¸ ì˜ì—­ ë§¨ ì•„ë˜ì— **í…ìŠ¤íŠ¸ë°•ìŠ¤ + ì•¡ì…˜ ë²„íŠ¼(ìš”ì•½/ë²ˆì—­/ë¦¬ë·°/ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°)**ë¥¼ ë„£ì—ˆë‹¤.

ê·¼ê±°: Streamlitì˜ st.chat_inputì€ ê¸°ë³¸ê°’ ì£¼ì…/ìœ„ì¹˜ ë³€ê²½ì´ ë¶ˆê°€(í•˜ë‹¨ ê³ ì •í˜•). ë”°ë¼ì„œ í™•ì¥í˜• ì…ë ¥ UIëŠ” ë©”ì¸ ì»¨í…Œì´ë„ˆì— ì‚¬ìš©ì ì •ì˜ í…ìŠ¤íŠ¸ ì˜ì—­ + ë²„íŠ¼ìœ¼ë¡œ êµ¬í˜„í•´ì•¼ í•œë‹¤ëŠ” ì œì•½ì´ ìˆë‹¤(ê³µì‹ ìœ„ì ¯ ìŠ¤í™).

# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ ë¼ì´íŠ¸ & ìƒí¼í•œ ì»¬ëŸ¬ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;
  --user:#ecfeff;
  --bot:#fff7ed;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
div.stTextInput>div>div>input, textarea, .stSelectbox [data-baseweb="select"]{
  background-color:#ffffff !important; color:var(--text) !important; border:1px solid var(--border) !important;
}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.chat-header{
  border:1px solid var(--border);
  background: linear-gradient(90deg, #f0fdf4, #ecfeff 60%, #f0f9ff);
  padding:16px 20px; border-radius:14px;
  box-shadow: 0 8px 24px rgba(2,132,199,.12);
}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
hr{border-color:var(--border);}
small.hint{color:var(--muted);}
kbd{background:#f8fafc; border:1px solid var(--border); border-bottom-width:2px; padding:1px 6px; border-radius:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ <b>ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸</b>ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
        <b>API KeyëŠ” ì…ë ¥ì°½ì— ë„£ìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥</b>ë©ë‹ˆë‹¤(Secrets ë¶ˆí•„ìš”).
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ì‚¬ì´ë“œë°”(ì„¤ì •/ìœ í‹¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë©ë‹ˆë‹¤. ìƒˆ ì„¸ì…˜/ìƒˆ íƒ­ì—ì„  ë‹¤ì‹œ ì…ë ¥ í•„ìš”."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0
    )
    temperature = st.slider("Temperature", 0.0, 1.2, 0.7, 0.1)
    max_tokens = st.slider("Max tokens(ì‘ë‹µ)", 256, 4096, 1024, 64)

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100
    )

    st.divider()
    col_a, col_b = st.columns(2)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True)
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True)

# â”€â”€ ì„¸ì…˜ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    if api_key_input and api_key_input.strip():
        st.session_state["OPENAI_API_KEY"] = api_key_input.strip()

    key = st.session_state.get("OPENAI_API_KEY", "").strip()
    if not key:
        return None
    try:
        return OpenAI(api_key=key)
    except openai.OpenAIError as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}", icon="ğŸ’¥")
        return None

client = get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë°(ë¬¸ìì—´ ì œë„ˆë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(
    _client: OpenAI,
    _messages: List[Dict[str, str]],
    _model: str,
    _temperature: float,
    _max_tokens: int,
) -> Generator[str, None, None]:
    resp = _client.chat.completions.create(
        model=_model,
        messages=_messages,
        temperature=_temperature,
        max_tokens=_max_tokens,
        stream=True,
    )
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta, "content", None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen: Generator[str, None, None]) -> str:
    if hasattr(st, "write_stream"):
        return st.write_stream(gen)
    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>'
            f'{"".join(acc)}</div>',
            unsafe_allow_html=True
        )
    return "".join(acc)

# â”€â”€ ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role == "assistant" else "user",
                         avatar="ğŸ¤–" if role == "assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{content}</div>',
            unsafe_allow_html=True
        )

for m in st.session_state.messages:
    render_message(m["role"], m["content"], m.get("time"))

# â”€â”€ í‚¤ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if client is None:
    st.info("ì‚¬ì´ë“œë°”ì— **OpenAI API Key**ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤.", icon="ğŸ”")

# â”€â”€ ììœ  ì±„íŒ… ì…ë ¥(í•˜ë‹¨ ê³ ì •) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")

if user_input and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": user_input}
    history.append(user_msg)

    render_message("user", user_input)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

# â”€â”€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤(í…ìŠ¤íŠ¸ + ì•¡ì…˜ ë²„íŠ¼) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
with st.container():
    st.markdown("#### í”„ë¡¬í”„íŠ¸")
    main_text = st.text_area(
        "ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  ìš”ì•½/ë²ˆì—­/ë¦¬ë·° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.",
        key="__main_task_area",
        height=160,
        label_visibility="collapsed",
        placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°â€¦"
    )
    c1, c2, c3, c4 = st.columns([1,1,1,1])
    send_prompt = None
    if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="main_sum"):
        send_prompt = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n" + (main_text or "")
    if c2.button("ì˜â†’í•œ ë²ˆì—­", use_container_width=True, key="main_tr"):
        send_prompt = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + (main_text or "")
    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="main_rev"):
        send_prompt = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n" + (main_text or "")
    if c4.button("ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°", use_container_width=True, key="main_send"):
        send_prompt = main_text or ""

# ì»¤ìŠ¤í…€ ë°•ìŠ¤ì—ì„œ ëˆŒë €ë‹¤ë©´ ì¦‰ì‹œ ì „ì†¡(ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€)
if send_prompt and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": send_prompt}
    history.append(user_msg)

    render_message("user", send_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )
    st.rerun()

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname = f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button(
        "ëŒ€í™” ë‚´ìš© ì €ì¥",
        data=json.dumps(st.session_state.messages, ensure_ascii=False, indent=2),
        file_name=fname,
        mime="application/json",
        use_container_width=True
    )
    st.caption("ëŒ€í™” ê¸°ë¡ì„ JSONìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")

# â”€â”€ ë¹Œë“œ íƒœê·¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
st.caption("build: streamlit_app.py Â· layout=wide Â· light theme")
í¬ì¸íŠ¸

ë©”ì¸ ì…ë ¥ ë°•ìŠ¤ë¥¼ ëŒ€í™” ì˜ì—­ ë§¨ ì•„ë˜ì— ë°°ì¹˜ â†’ ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ë°œí™” â†’ st.rerun()ìœ¼ë¡œ ìƒˆ ìƒíƒœ ë°˜ì˜.

st.chat_inputì€ ììœ  ì±„íŒ… ì „ìš©ìœ¼ë¡œ ìœ ì§€(í•„ìš” ì‹œ ì´í›„ ì œê±° ê°€ëŠ¥).

ë¬¸ì œ ì—†ìœ¼ë©´ ì´ëŒ€ë¡œ ì»¤ë°‹/í‘¸ì‹œ(â†’ Streamlit Cloud ìë™ ë°°í¬)í•˜ë©´ ëœë‹¤.

ë‚˜ì˜ ë§:
ì—…ë¡œë“œí•œ ì´ë¯¸ì§€
í•œì˜ ë²ˆì—­ì´ ì•ˆë˜ê³  í”„ë¡¬í”„íŠ¸ì— ëŒ€í•œ ê²°ê³¼ê°’ì´ ë‚˜ì˜¨ í›„ì—ëŠ” í”„ë¡¬í”„íŠ¸ ì°½ì´ ë¹„ì–´ ìˆì–´ì•¼ í•˜ëŠ”ë° ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ê°€ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆìŒ ì˜¤ë¥˜ ìˆ˜ì •í•´ì¤˜
ChatGPTì˜ ë§:

17s ë™ì•ˆ ìƒê°í•¨
ì¢‹ì•„, ë‘ ê°€ì§€ë¥¼ ì •í™•íˆ ê³ ì¹œë‹¤.

ë²ˆì—­ ë°©í–¥ ì„ íƒ ì¶”ê°€(ì˜â†’í•œ / í•œâ†’ì˜) â†’ ë„ˆê°€ í•œêµ­ì–´ í…ìŠ¤íŠ¸ë¥¼ ë„£ê³  â€œì˜â†’í•œâ€ì„ ëˆŒëŸ¬ë„ ë³€í™˜ì´ ì•ˆ ë˜ëŠ” ë¬¸ì œ í•´ê²°.

ì‘ë‹µ í›„ í”„ë¡¬í”„íŠ¸ ë¹„ìš°ê¸° â†’ ê²°ê³¼ê°€ ë‚˜ì˜¤ë©´ ë©”ì¸ í…ìŠ¤íŠ¸ë°•ìŠ¤ë¥¼ ì¦‰ì‹œ ì´ˆê¸°í™”.

ì•„ë˜ íŒ¨ì¹˜ ë¶€ë¶„ë§Œ ì ìš©í•˜ë©´ ëœë‹¤(ì „ì²´íŒŒì¼ êµì²´ ë¶ˆí•„ìš”).

1) ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤ì— â€œë²ˆì—­ ë°©í–¥â€ ë¼ë””ì˜¤ ì¶”ê°€ + ë²„íŠ¼ ë¡œì§ ìˆ˜ì •
# â”€â”€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤(í…ìŠ¤íŠ¸ + ì•¡ì…˜ ë²„íŠ¼) â”€â”€ ë¸”ë¡ì„ ë‹¤ìŒì²˜ëŸ¼ ë°”ê¿”ì¤˜.

st.markdown("<hr/>", unsafe_allow_html=True)
with st.container():
    st.markdown("#### í”„ë¡¬í”„íŠ¸")
    main_text = st.text_area(
        "ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  ìš”ì•½/ë²ˆì—­/ë¦¬ë·° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.",
        key="__main_task_area",
        height=160,
        label_visibility="collapsed",
        placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°â€¦"
    )

    # ë²ˆì—­ ë°©í–¥ ì„ íƒ (ì˜â†’í•œ / í•œâ†’ì˜)
    trans_dir = st.radio(
        "ë²ˆì—­ ë°©í–¥",
        options=("ì˜â†’í•œ", "í•œâ†’ì˜"),
        horizontal=True,
        key="__trans_dir"
    )

    c1, c2, c3, c4 = st.columns([1,1,1,1])
    send_prompt = None

    # ë¹ˆ ì…ë ¥ ë°©ì§€
    def guard_empty():
        if not (main_text or "").strip():
            st.warning("í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", icon="âš ï¸")
            return True
        return False

    if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="main_sum"):
        if not guard_empty():
            send_prompt = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n" + main_text

    if c2.button("ë²ˆì—­", use_container_width=True, key="main_tr"):
        if not guard_empty():
            if trans_dir == "ì˜â†’í•œ":
                send_prompt = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + main_text
            else:  # í•œâ†’ì˜
                send_prompt = "ì•„ë˜ í•œêµ­ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + main_text

    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="main_rev"):
        if not guard_empty():
            send_prompt = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n" + main_text

    if c4.button("ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°", use_container_width=True, key="main_send"):
        if not guard_empty():
            send_prompt = main_text
2) ì „ì†¡ ì§í›„ í…ìŠ¤íŠ¸ë°•ìŠ¤ ë¹„ìš°ê¸°
ê°™ì€ ë¸”ë¡ ì•„ë˜ì˜ ì „ì†¡ ì²˜ë¦¬ë¶€(í˜„ì¬ if send_prompt and client: ì´í•˜)ì— ì´ˆê¸°í™” í•œ ì¤„ì„ ì¶”ê°€:

if send_prompt and client:
    # ... (íˆìŠ¤í† ë¦¬ êµ¬ì„±/ìŠ¤íŠ¸ë¦¬ë° ê·¸ëŒ€ë¡œ)
    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

    # >>> í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” (ì¤‘ìš”)
    st.session_state["__main_task_area"] = ""

    st.rerun()
ì´ë ‡ê²Œ í•˜ë©´,

ë²ˆì—­ì€ ì„ íƒí•œ ë°©í–¥ëŒ€ë¡œ ì‘ë™í•˜ê³ ,

ì‘ë‹µì´ ëë‚˜ë©´ ì…ë ¥ì¹¸ì´ ì¦‰ì‹œ ë¹„ì›Œì§„ë‹¤(ì„¸ì…˜ ìŠ¤í…Œì´íŠ¸ë¡œ ìœ„ì ¯ ê°’ì„ ë¦¬ì…‹ + st.rerun()ìœ¼ë¡œ ë°˜ì˜).
ê·¼ê±°: st.session_stateë¡œ ìœ„ì ¯ ê°’ì„ ì œì–´í•  ìˆ˜ ìˆê³ , st.rerun()ì€ ì¦‰ì‹œ ì¬ì‹¤í–‰í•˜ì—¬ í™”ë©´ì„ ì—…ë°ì´íŠ¸í•œë‹¤. 
docs.streamlit.io
+1

ì°¸ê³ : st.chat_inputì€ ê°’ ì£¼ì…/ê¸°ë³¸ê°’ ì„¤ì •ì´ ê³µì‹ì ìœ¼ë¡œ ì§€ì›ë˜ì§€ ì•Šì•„(ì´ìŠˆë¡œ ë‚¨ì•„ ìˆìŒ) ë©”ì¸ ì»¨í…Œì´ë„ˆì— ì‚¬ìš©ì ì •ì˜ í…ìŠ¤íŠ¸ì˜ì—­ + ë²„íŠ¼ì„ ì“°ëŠ” ë°©ì‹ì´ ê°€ì¥ ì•ˆì „í•˜ë‹¤. 
GitHub
+2
Streamlit
+2

í•„ìš”í•˜ë©´ ìš”ì•½ ë¬¸ì¥ ìˆ˜ ìŠ¬ë¼ì´ë”, ë²ˆì—­ í†¤(ê²©ì‹/ìºì£¼ì–¼) ì˜µì…˜ë„ ë§ë¶™ì—¬ì¤„ê²Œ.

ë‚˜ì˜ ë§:
ã…‡ã…‡ ì „ì²´ ì½”ë“œ
ChatGPTì˜ ë§:
ì¢‹ì•„. ìˆ˜ì • ë°˜ì˜í•œ ì „ì²´ ì½”ë“œë‹¤.
ë³€ê²½ì : ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤ + ë²ˆì—­ ë°©í–¥(ì˜â†’í•œ/í•œâ†’ì˜) ì„ íƒ ì¶”ê°€, ì‘ë‹µ í›„ í”„ë¡¬í”„íŠ¸ ìë™ ì´ˆê¸°í™”.

# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ ë¼ì´íŠ¸ & ìƒí¼í•œ ì»¬ëŸ¬ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;
  --user:#ecfeff;
  --bot:#fff7ed;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
div.stTextInput>div>div>input, textarea, .stSelectbox [data-baseweb="select"]{
  background-color:#ffffff !important; color:var(--text) !important; border:1px solid var(--border) !important;
}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.chat-header{
  border:1px solid var(--border);
  background: linear-gradient(90deg, #f0fdf4, #ecfeff 60%, #f0f9ff);
  padding:16px 20px; border-radius:14px;
  box-shadow: 0 8px 24px rgba(2,132,199,.12);
}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
hr{border-color:var(--border);}
small.hint{color:var(--muted);}
kbd{background:#f8fafc; border:1px solid var(--border); border-bottom-width:2px; padding:1px 6px; border-radius:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ <b>ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸</b>ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
        <b>API KeyëŠ” ì…ë ¥ì°½ì— ë„£ìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥</b>ë©ë‹ˆë‹¤(Secrets ë¶ˆí•„ìš”).
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ì‚¬ì´ë“œë°”(ì„¤ì •/ìœ í‹¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë©ë‹ˆë‹¤. ìƒˆ ì„¸ì…˜/ìƒˆ íƒ­ì—ì„  ë‹¤ì‹œ ì…ë ¥ í•„ìš”."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0
    )
    temperature = st.slider("Temperature", 0.0, 1.2, 0.7, 0.1)
    max_tokens = st.slider("Max tokens(ì‘ë‹µ)", 256, 4096, 1024, 64)

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100
    )

    st.divider()
    col_a, col_b = st.columns(2)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True)
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True)

# â”€â”€ ì„¸ì…˜ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    if api_key_input and api_key_input.strip():
        st.session_state["OPENAI_API_KEY"] = api_key_input.strip()
    key = st.session_state.get("OPENAI_API_KEY", "").strip()
    if not key:
        return None
    try:
        return OpenAI(api_key=key)
    except openai.OpenAIError as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}", icon="ğŸ’¥")
        return None

client = get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë°(ë¬¸ìì—´ ì œë„ˆë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(
    _client: OpenAI,
    _messages: List[Dict[str, str]],
    _model: str,
    _temperature: float,
    _max_tokens: int,
) -> Generator[str, None, None]:
    resp = _client.chat.completions.create(
        model=_model,
        messages=_messages,
        temperature=_temperature,
        max_tokens=_max_tokens,
        stream=True,
    )
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta, "content", None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen: Generator[str, None, None]) -> str:
    if hasattr(st, "write_stream"):
        return st.write_stream(gen)
    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>'
            f'{"".join(acc)}</div>',
            unsafe_allow_html=True
        )
    return "".join(acc)

# â”€â”€ ê¸°ì¡´ ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role == "assistant" else "user",
                         avatar="ğŸ¤–" if role == "assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{content}</div>',
            unsafe_allow_html=True
        )

for m in st.session_state.messages:
    render_message(m["role"], m["content"], m.get("time"))

# â”€â”€ í‚¤ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if client is None:
    st.info("ì‚¬ì´ë“œë°”ì— **OpenAI API Key**ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤.", icon="ğŸ”")

# â”€â”€ ììœ  ì±„íŒ… ì…ë ¥(í•˜ë‹¨ ê³ ì •) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")

if user_input and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": user_input}
    history.append(user_msg)

    render_message("user", user_input)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

# â”€â”€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤(í…ìŠ¤íŠ¸ + ë²ˆì—­ ë°©í–¥ + ì•¡ì…˜ ë²„íŠ¼) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
with st.container():
    st.markdown("#### í”„ë¡¬í”„íŠ¸")
    main_text = st.text_area(
        "ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  ìš”ì•½/ë²ˆì—­/ë¦¬ë·° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.",
        key="__main_task_area",
        height=160,
        label_visibility="collapsed",
        placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°â€¦"
    )

    trans_dir = st.radio(
        "ë²ˆì—­ ë°©í–¥",
        options=("ì˜â†’í•œ", "í•œâ†’ì˜"),
        horizontal=True,
        key="__trans_dir"
    )

    c1, c2, c3, c4 = st.columns([1,1,1,1])
    send_prompt = None

    def guard_empty() -> bool:
        if not (main_text or "").strip():
            st.warning("í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", icon="âš ï¸")
            return True
        return False

    if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="main_sum"):
        if not guard_empty():
            send_prompt = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n" + main_text

    if c2.button("ë²ˆì—­", use_container_width=True, key="main_tr"):
        if not guard_empty():
            if trans_dir == "ì˜â†’í•œ":
                send_prompt = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + main_text
            else:
                send_prompt = "ì•„ë˜ í•œêµ­ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + main_text

    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="main_rev"):
        if not guard_empty():
            send_prompt = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n" + main_text

    if c4.button("ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°", use_container_width=True, key="main_send"):
        if not guard_empty():
            send_prompt = main_text

# ì»¤ìŠ¤í…€ ë°•ìŠ¤ì—ì„œ ëˆŒë €ë‹¤ë©´ ì¦‰ì‹œ ì „ì†¡(ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€) + ì…ë ¥ì°½ ì´ˆê¸°í™”
if send_prompt and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": send_prompt}
    history.append(user_msg)

    render_message("user", send_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

    # >>> ì‘ë‹µ í›„ í”„ë¡¬í”„íŠ¸ ë¹„ìš°ê¸°
    st.session_state["__main_task_area"] = ""

    st.rerun()

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname = f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button(
        "ëŒ€í™” ë‚´ìš© ì €ì¥",
        data=json.dumps(st.session_state.messages, ensure_ascii=False, indent=2),
        file_name=fname,
        mime="application/json",
        use_container_width=True
    )
    st.caption("ëŒ€í™” ê¸°ë¡ì„ JSONìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")

# â”€â”€ ë¹Œë“œ íƒœê·¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
st.caption("build: streamlit_app.py Â· layout=wide Â· light theme")
í•µì‹¬ ê·¼ê±°

ë²ˆì—­ ë°©í–¥ì„ ëª…ì‹œì ìœ¼ë¡œ ì„ íƒí•´ í”„ë¡¬í”„íŠ¸ì— ë°˜ì˜í•´ì•¼ ëª¨ë¸ì´ ì›í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ë™ì‘í•œë‹¤.

ì…ë ¥ ìœ„ì ¯ ê°’ì€ st.session_state["ìœ„ì ¯í‚¤"]= ""ë¡œ ì´ˆê¸°í™” í›„ st.rerun()ìœ¼ë¡œ ì¦‰ì‹œ í™”ë©´ ë°˜ì˜ ê°€ëŠ¥.

ë‚˜ì˜ ë§:
ì—…ë¡œë“œí•œ ì´ë¯¸ì§€
ì˜¤ë¥˜ ìˆ˜ì •
ChatGPTì˜ ë§:
ë„ë¦¬, ì›ì¸ì€ st.text_area(key="__main_task_area")ë¥¼ ë§Œë“  ë’¤ ê°™ì€ ëŸ°ì—ì„œ st.session_state["__main_task_area"] = ""ë¡œ ê°’ì„ ë°”ê¿”ì„œì˜ˆìš”. Streamlitì€ ìœ„ì ¯ ìƒì„± ì´í›„ ë™ì¼ í‚¤ ì§ì ‘ ëŒ€ì…ì„ ê¸ˆì§€í•©ë‹ˆë‹¤.
í•´ê²°: â€œì´ˆê¸°í™” í”Œë˜ê·¸â€ë¥¼ ì„¸ì…˜ì— ë‚¨ê¸°ê³  st.rerun() â†’ ë‹¤ìŒ ì‹¤í–‰ì—ì„œ ìœ„ì ¯ ë§Œë“¤ê¸° ì „ì— ê°’ì„ ë¹„ì›ë‹ˆë‹¤.

ì•„ë˜ íŒŒì¼ë¡œ êµì²´í•˜ë©´ ëë‚˜ìš”. ë³€ê²½ í•µì‹¬ì€

ìœ„ìª½ â€œì„¸ì…˜ ì´ˆê¸°í™” ì˜ì—­â€ ì¶”ê°€

ì „ì†¡ ì§í›„ __clear_main í”Œë˜ê·¸ë§Œ ì¼œê³  st.rerun() (ì§ì ‘ ëŒ€ì… ê¸ˆì§€)

# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ ë¼ì´íŠ¸ & ìƒí¼í•œ ì»¬ëŸ¬ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;
  --user:#ecfeff;
  --bot:#fff7ed;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
div.stTextInput>div>div>input, textarea, .stSelectbox [data-baseweb="select"]{
  background-color:#ffffff !important; color:var(--text) !important; border:1px solid var(--border) !important;
}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.chat-header{
  border:1px solid var(--border);
  background: linear-gradient(90deg, #f0fdf4, #ecfeff 60%, #f0f9ff);
  padding:16px 20px; border-radius:14px;
  box-shadow: 0 8px 24px rgba(2,132,199,.12);
}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
hr{border-color:var(--border);}
small.hint{color:var(--muted);}
kbd{background:#f8fafc; border:1px solid var(--border); border-bottom-width:2px; padding:1px 6px; border-radius:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ <b>ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸</b>ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
        <b>API KeyëŠ” ì…ë ¥ì°½ì— ë„£ìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥</b>ë©ë‹ˆë‹¤(Secrets ë¶ˆí•„ìš”).
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ì„¸ì…˜ ì¤€ë¹„/ì´ˆê¸°í™”(ìœ„ì ¯ ìƒì„± ì „) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í”„ë¡¬í”„íŠ¸ ì…ë ¥ ìœ„ì ¯ìš© í‚¤ë¥¼ ë¯¸ë¦¬ ì¤€ë¹„
if "__main_task_area" not in st.session_state:
    st.session_state["__main_task_area"] = ""
if "__trans_dir" not in st.session_state:
    st.session_state["__trans_dir"] = "ì˜â†’í•œ"
# ì´ì „ ëŸ°ì—ì„œ ì´ˆê¸°í™” í”Œë˜ê·¸ê°€ ì¼œì¡Œë‹¤ë©´, ì—¬ê¸°ì„œ ê°’ì„ ë¹„ìš°ê³  í”Œë˜ê·¸ í•´ì œ
if st.session_state.get("__clear_main"):
    st.session_state["__main_task_area"] = ""
    st.session_state["__clear_main"] = False

# â”€â”€ ì‚¬ì´ë“œë°”(ì„¤ì •/ìœ í‹¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë©ë‹ˆë‹¤. ìƒˆ ì„¸ì…˜/ìƒˆ íƒ­ì—ì„  ë‹¤ì‹œ ì…ë ¥ í•„ìš”."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0
    )
    temperature = st.slider("Temperature", 0.0, 1.2, 0.7, 0.1)
    max_tokens = st.slider("Max tokens(ì‘ë‹µ)", 256, 4096, 1024, 64)

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100
    )

    st.divider()
    col_a, col_b = st.columns(2)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True)
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True)

# â”€â”€ ì„¸ì…˜ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    if api_key_input and api_key_input.strip():
        st.session_state["OPENAI_API_KEY"] = api_key_input.strip()
    key = st.session_state.get("OPENAI_API_KEY", "").strip()
    if not key:
        return None
    try:
        return OpenAI(api_key=key)
    except openai.OpenAIError as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}", icon="ğŸ’¥")
        return None

client = get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë°(ë¬¸ìì—´ ì œë„ˆë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(
    _client: OpenAI,
    _messages: List[Dict[str, str]],
    _model: str,
    _temperature: float,
    _max_tokens: int,
) -> Generator[str, None, None]:
    resp = _client.chat.completions.create(
        model=_model,
        messages=_messages,
        temperature=_temperature,
        max_tokens=_max_tokens,
        stream=True,
    )
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta, "content", None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen: Generator[str, None, None]) -> str:
    if hasattr(st, "write_stream"):
        return st.write_stream(gen)
    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>'
            f'{"".join(acc)}</div>',
            unsafe_allow_html=True
        )
    return "".join(acc)

# â”€â”€ ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role == "assistant" else "user",
                         avatar="ğŸ¤–" if role == "assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{content}</div>',
            unsafe_allow_html=True
        )

for m in st.session_state.messages:
    render_message(m["role"], m["content"], m.get("time"))

# â”€â”€ í‚¤ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if client is None:
    st.info("ì‚¬ì´ë“œë°”ì— **OpenAI API Key**ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤.", icon="ğŸ”")

# â”€â”€ ììœ  ì±„íŒ… ì…ë ¥(í•˜ë‹¨ ê³ ì •) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
if user_input and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": user_input}
    history.append(user_msg)

    render_message("user", user_input)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

# â”€â”€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤(í…ìŠ¤íŠ¸ + ë²ˆì—­ ë°©í–¥ + ì•¡ì…˜ ë²„íŠ¼) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
with st.container():
    st.markdown("#### í”„ë¡¬í”„íŠ¸")
    main_text = st.text_area(
        "ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  ìš”ì•½/ë²ˆì—­/ë¦¬ë·° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.",
        key="__main_task_area",   # ê°’ì„ ì§ì ‘ ëŒ€ì…í•˜ì§€ ë§ê³  í‚¤ë¡œ ê´€ë¦¬
        height=160,
        label_visibility="collapsed",
        placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°â€¦"
    )

    trans_dir = st.radio(
        "ë²ˆì—­ ë°©í–¥",
        options=("ì˜â†’í•œ", "í•œâ†’ì˜"),
        horizontal=True,
        key="__trans_dir"
    )

    c1, c2, c3, c4 = st.columns([1,1,1,1])
    send_prompt = None

    def guard_empty() -> bool:
        if not (st.session_state["__main_task_area"] or "").strip():
            st.warning("í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", icon="âš ï¸")
            return True
        return False

    if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="main_sum"):
        if not guard_empty():
            send_prompt = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]

    if c2.button("ë²ˆì—­", use_container_width=True, key="main_tr"):
        if not guard_empty():
            if st.session_state["__trans_dir"] == "ì˜â†’í•œ":
                send_prompt = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]
            else:
                send_prompt = "ì•„ë˜ í•œêµ­ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]

    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="main_rev"):
        if not guard_empty():
            send_prompt = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n" + st.session_state["__main_task_area"]

    if c4.button("ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°", use_container_width=True, key="main_send"):
        if not guard_empty():
            send_prompt = st.session_state["__main_task_area"]

# ì»¤ìŠ¤í…€ ë°•ìŠ¤ì—ì„œ ëˆŒë €ë‹¤ë©´ ì¦‰ì‹œ ì „ì†¡(ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€) + ë‹¤ìŒ ëŸ°ì—ì„œ ë¹„ìš°ê¸°
if send_prompt and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": send_prompt}
    history.append(user_msg)

    render_message("user", send_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

    # ì—¬ê¸°ì„œ ì§ì ‘ "__main_task_area"ì— ëŒ€ì…í•˜ì§€ ë§ ê²ƒ!
    st.session_state["__clear_main"] = True  # ë‹¤ìŒ ì‹¤í–‰ì—ì„œ ìœ„ì ¯ ìƒì„± ì „ì— ë¹„ì›€
    st.rerun()

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname = f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button(
        "ëŒ€í™” ë‚´ìš© ì €ì¥",
        data=json.dumps(st.session_state.messages, ensure_ascii=False, indent=2),
        file_name=fname,
        mime="application/json",
        use_container_width=True
    )
    st.caption("ëŒ€í™” ê¸°ë¡ì„ JSONìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")

# â”€â”€ ë¹Œë“œ íƒœê·¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
st.caption("build: streamlit_app.py Â· layout=wide Â· light theme")
í•µì‹¬ ê·¼ê±°

Streamlit ì œì•½: ìœ„ì ¯ ìƒì„± í›„ ê°™ì€ ëŸ°ì—ì„œ ë™ì¼ í‚¤ì— ì§ì ‘ ëŒ€ì…í•˜ë©´ ì˜ˆì™¸ ë°œìƒ.

íŒ¨í„´: í”Œë˜ê·¸(__clear_main) â†’ st.rerun() â†’ ë‹¤ìŒ ëŸ°ì—ì„œ ìœ„ì ¯ ìƒì„± ì „ì— ê°’ì„ ì´ˆê¸°í™”.

ì ìš© í›„ì—ë„ ë¬¸ì œ ìˆìœ¼ë©´ ì—ëŸ¬ ë¼ì¸ ìŠ¤í¬ë¦°ìƒ· ì£¼ë©´ ë°”ë¡œ ë” ì†ë³¼ê²Œ.

ë‚˜ì˜ ë§:
Model

gpt-4o-mini
Temperature

Max tokens(ì‘ë‹µ)

System prompt

ì´ì— ëŒ€í•œ ì„¤ëª…ì´ ìˆìœ¼ë©´ ì¢‹ê² ë‹¤. ë¡¤ì˜¤ë²„ë¥¼ í•˜ë©´ ì„¤ëª…ì„ ë„ì›Œ ì¤€ë‹¤ë“ ì§€ ê°€ì¥ ì¢‹ì€ ë°©ë²•ìœ¼ë¡œ ì½”ë“œ ìˆ˜ì •í•´ì¤˜.
ChatGPTì˜ ë§:
ì¢‹ì€ ê°œì„  í¬ì¸íŠ¸ì•¼ ë„ë¦¬!
ì§€ê¸ˆ Model, Temperature, Max tokens, System promptëŠ” ë‹¨ìˆœí•œ ì…ë ¥ UIì¸ë°, ì‚¬ìš©ìê°€ ì˜ë¯¸ë¥¼ í—·ê°ˆë¦´ ìˆ˜ ìˆì–´. Streamlitì—ì„œ ë¡¤ì˜¤ë²„(hover) ì„¤ëª…ì€ ê° ìœ„ì ¯ì— help ì†ì„±ì„ ë‹¬ì•„ì£¼ëŠ” ê²Œ ê°€ì¥ ì§ê´€ì ì´ê³  ê¹”ë”í•œ ë°©ë²•ì´ì•¼.

ğŸ”§ ì½”ë“œ ìˆ˜ì • ì˜ˆì‹œ
ì‚¬ì´ë“œë°” UI ë¶€ë¶„ì„ ì´ë ‡ê²Œ ê³ ì¹˜ë©´ ë¼:

with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="OpenAI API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ìƒˆë¡œê³ ì¹¨ ì „ê¹Œì§€ ìœ ì§€ë©ë‹ˆë‹¤."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0,
        help="ì‚¬ìš©í•  OpenAI ëª¨ë¸ì„ ì„ íƒí•©ë‹ˆë‹¤.\n- gpt-4o-mini: ë¹ ë¥´ê³  ì €ë ´, ê°€ë²¼ìš´ ì‘ì—…ìš©\n- gpt-4o: ê³ í’ˆì§ˆ ì‘ë‹µ\n- gpt-4.1-mini, gpt-3.5-turbo: ë¹„ìš© ì ˆê° ì˜µì…˜"
    )

    temperature = st.slider(
        "Temperature",
        0.0, 1.2, 0.7, 0.1,
        help="ì°½ì˜ì„±(ëœë¤ì„±) ì •ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤.\në‚®ìœ¼ë©´ ì¼ê´€ì„±â†‘, ë†’ìœ¼ë©´ ì°½ì˜ì  ì‘ë‹µâ†‘"
    )

    max_tokens = st.slider(
        "Max tokens(ì‘ë‹µ)",
        256, 4096, 1024, 64,
        help="ëª¨ë¸ì´ í•œ ë²ˆì— ìƒì„±í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í† í° ìˆ˜(ë‹¨ì–´ ì¡°ê°).\nê°’ì´ í¬ë©´ ê¸´ ë‹µë³€ ê°€ëŠ¥í•˜ì§€ë§Œ ë¹„ìš©/ì‹œê°„â†‘"
    )

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100,
        help="ëª¨ë¸ì˜ ê¸°ë³¸ ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.\nì˜ˆ: 'ì¹œì ˆí•œ ì„ ìƒë‹˜ì²˜ëŸ¼ ì„¤ëª…í•´ì¤˜'"
    )
ğŸ“Œ ê²°ê³¼
ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ê° í•­ëª©ì— ëŒ€í•œ ì„¤ëª…(tooltip)ì´ ëœ¸.

ì„¤ëª…ì—ëŠ” ëª¨ë¸ íŠ¹ì§•, temperature ì˜ë¯¸, max_tokens ì—­í• , system prompt ì‚¬ìš©ë²•ì´ ê°„ê²°íˆ ë‹´ê¹€.

ê°€ì¥ ë‹¨ìˆœí•˜ë©´ì„œ ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì¢‹ì€ ë°©ì‹.

ğŸ‘‰ ë„ë¦¬, í˜¹ì‹œ ë” ê³ ê¸‰ìŠ¤ëŸ½ê²Œ ì•„ì´ì½˜ ì˜†ì— â„¹ï¸ ë²„íŠ¼ì„ ë‘ê³  í´ë¦­í•˜ë©´ íŒì—…(ì˜ˆ: st.popover)ìœ¼ë¡œ ì„¤ëª…ì„ ë„ìš°ëŠ” ë°©ì‹ë„ ì›í•´? ì•„ë‹ˆë©´ ì§€ê¸ˆì²˜ëŸ¼ ë¡¤ì˜¤ë²„ íˆ´íŒì´ ì œì¼ ê¹”ë”í• ê¹Œ?

ë‚˜ì˜ ë§:
ì „ì²´ ì½”ë“œë¡œ ë‹¤ì‹œ ì¤˜
ChatGPTì˜ ë§:
ì¢‹ì•„, íˆ´íŒ(ë¡¤ì˜¤ë²„ ì„¤ëª…) ì¶”ê°€ + ë²ˆì—­ ë°©í–¥ + ì‘ë‹µ í›„ ì…ë ¥ì°½ ìë™ ë¹„ì›€ + ì„¸ì…˜-ì„¸ì´í”„ ì´ˆê¸°í™”ë¥¼ ëª¨ë‘ ë°˜ì˜í•œ ì „ì²´ ì½”ë“œì•¼. ê·¸ëŒ€ë¡œ streamlit_app.pyì— ë¶™ì—¬ ë„£ê³  ì»¤ë°‹/í‘¸ì‹œí•˜ë©´ ëœë‹¤.

# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ ë¼ì´íŠ¸ & ìƒí¼í•œ ì»¬ëŸ¬ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;
  --user:#ecfeff;
  --bot:#fff7ed;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
div.stTextInput>div>div>input, textarea, .stSelectbox [data-baseweb="select"]{
  background-color:#ffffff !important; color:var(--text) !important; border:1px solid var(--border) !important;
}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.chat-header{
  border:1px solid var(--border);
  background: linear-gradient(90deg, #f0fdf4, #ecfeff 60%, #f0f9ff);
  padding:16px 20px; border-radius:14px;
  box-shadow: 0 8px 24px rgba(2,132,199,.12);
}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
hr{border-color:var(--border);}
small.hint{color:var(--muted);}
kbd{background:#f8fafc; border:1px solid var(--border); border-bottom-width:2px; padding:1px 6px; border-radius:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ <b>ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸</b>ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
        <b>API KeyëŠ” ì…ë ¥ì°½ì— ë„£ìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥</b>ë©ë‹ˆë‹¤(Secrets ë¶ˆí•„ìš”).
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ì„¸ì…˜ ì¤€ë¹„/ì´ˆê¸°í™”(ìœ„ì ¯ ìƒì„± ì „) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì¸ í”„ë¡¬í”„íŠ¸ì™€ ì˜µì…˜ ê¸°ë³¸ê°’ì„ ìœ„ì ¯ ìƒì„± ì „ì— ì¤€ë¹„
if "__main_task_area" not in st.session_state:
    st.session_state["__main_task_area"] = ""
if "__trans_dir" not in st.session_state:
    st.session_state["__trans_dir"] = "ì˜â†’í•œ"
# ì´ì „ ëŸ°ì—ì„œ ì…ë ¥ì°½ ì´ˆê¸°í™” í”Œë˜ê·¸ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ë¨¼ì € ë¹„ìš°ê³  í”Œë˜ê·¸ í•´ì œ
if st.session_state.get("__clear_main"):
    st.session_state["__main_task_area"] = ""
    st.session_state["__clear_main"] = False

# â”€â”€ ì‚¬ì´ë“œë°”(ì„¤ì •/ìœ í‹¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="OpenAI API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ìƒˆë¡œê³ ì¹¨ ì „ê¹Œì§€ ìœ ì§€ë©ë‹ˆë‹¤."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0,
        help="ì‚¬ìš©í•  OpenAI ëª¨ë¸ì„ ì„ íƒí•©ë‹ˆë‹¤.\n- gpt-4o-mini: ë¹ ë¥´ê³  ì €ë ´(ê°€ë²¼ìš´ ì‘ì—…)\n- gpt-4o: ê³ í’ˆì§ˆ ì‘ë‹µ\n- gpt-4.1-mini / gpt-3.5-turbo: ë¹„ìš© ì ˆê° ì˜µì…˜"
    )

    temperature = st.slider(
        "Temperature",
        0.0, 1.2, 0.7, 0.1,
        help="ì‘ë‹µì˜ ì°½ì˜ì„±(ëœë¤ì„±)ì„ ì¡°ì ˆí•©ë‹ˆë‹¤. ë‚®ì„ìˆ˜ë¡ ì¼ê´€ì„±â†‘, ë†’ì„ìˆ˜ë¡ ë‹¤ì–‘ì„±/ì°½ì˜ì„±â†‘"
    )

    max_tokens = st.slider(
        "Max tokens(ì‘ë‹µ)",
        256, 4096, 1024, 64,
        help="ëª¨ë¸ì´ í•œ ë²ˆì— ìƒì„±í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í† í° ìˆ˜(ë‹¨ì–´ ì¡°ê°). ê°’ì´ í´ìˆ˜ë¡ ê¸´ ë‹µë³€ ê°€ëŠ¥í•˜ì§€ë§Œ ë¹„ìš©/ì‹œê°„â†‘"
    )

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100,
        help="ëª¨ë¸ì˜ ê¸°ë³¸ ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì˜ˆ: 'ì¹œì ˆí•œ ì„ ìƒë‹˜ì²˜ëŸ¼ ì„¤ëª…í•´ì¤˜'"
    )

    st.divider()
    col_a, col_b = st.columns(2)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True, help="ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤.")
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True, help="í˜„ì¬ê¹Œì§€ì˜ ëŒ€í™” ë‚´ìš©ì„ JSONìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.")

# â”€â”€ ì„¸ì…˜ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    if api_key_input and api_key_input.strip():
        st.session_state["OPENAI_API_KEY"] = api_key_input.strip()
    key = st.session_state.get("OPENAI_API_KEY", "").strip()
    if not key:
        return None
    try:
        return OpenAI(api_key=key)
    except openai.OpenAIError as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}", icon="ğŸ’¥")
        return None

client = get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë°(ë¬¸ìì—´ ì œë„ˆë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(
    _client: OpenAI,
    _messages: List[Dict[str, str]],
    _model: str,
    _temperature: float,
    _max_tokens: int,
) -> Generator[str, None, None]:
    resp = _client.chat.completions.create(
        model=_model,
        messages=_messages,
        temperature=_temperature,
        max_tokens=_max_tokens,
        stream=True,
    )
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta, "content", None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen: Generator[str, None, None]) -> str:
    if hasattr(st, "write_stream"):
        return st.write_stream(gen)
    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>'
            f'{"".join(acc)}</div>',
            unsafe_allow_html=True
        )
    return "".join(acc)

# â”€â”€ ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role == "assistant" else "user",
                         avatar="ğŸ¤–" if role == "assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{content}</div>',
            unsafe_allow_html=True
        )

for m in st.session_state.messages:
    render_message(m["role"], m["content"], m.get("time"))

# â”€â”€ í‚¤ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if client is None:
    st.info("ì‚¬ì´ë“œë°”ì— **OpenAI API Key**ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤.", icon="ğŸ”")

# â”€â”€ ììœ  ì±„íŒ… ì…ë ¥(í•˜ë‹¨ ê³ ì •) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
if user_input and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": user_input}
    history.append(user_msg)

    render_message("user", user_input)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

# â”€â”€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤(í…ìŠ¤íŠ¸ + ë²ˆì—­ ë°©í–¥ + ì•¡ì…˜ ë²„íŠ¼) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
with st.container():
    st.markdown("#### í”„ë¡¬í”„íŠ¸")
    main_text = st.text_area(
        "ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  ìš”ì•½/ë²ˆì—­/ë¦¬ë·° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.",
        key="__main_task_area",     # ê°’ì„ ì§ì ‘ ëŒ€ì…í•˜ì§€ ì•Šê³  ì„¸ì…˜ í‚¤ë¡œ ê´€ë¦¬
        height=160,
        label_visibility="collapsed",
        placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°â€¦"
    )

    trans_dir = st.radio(
        "ë²ˆì—­ ë°©í–¥",
        options=("ì˜â†’í•œ", "í•œâ†’ì˜"),
        horizontal=True,
        key="__trans_dir",
        help="ë²ˆì—­ ë°©í–¥ì„ ì„ íƒí•˜ì„¸ìš”. ì„ íƒì— ë”°ë¼ ë²ˆì—­ í”„ë¡¬í”„íŠ¸ê°€ ìë™ êµ¬ì„±ë©ë‹ˆë‹¤."
    )

    c1, c2, c3, c4 = st.columns([1,1,1,1])
    send_prompt = None

    def guard_empty() -> bool:
        if not (st.session_state["__main_task_area"] or "").strip():
            st.warning("í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", icon="âš ï¸")
            return True
        return False

    if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="main_sum", help="ë¶™ì—¬ë„£ì€ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•©ë‹ˆë‹¤."):
        if not guard_empty():
            send_prompt = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]

    if c2.button("ë²ˆì—­", use_container_width=True, key="main_tr", help="ì„ íƒí•œ ë°©í–¥(ì˜â†’í•œ/í•œâ†’ì˜)ìœ¼ë¡œ ë²ˆì—­í•©ë‹ˆë‹¤."):
        if not guard_empty():
            if st.session_state["__trans_dir"] == "ì˜â†’í•œ":
                send_prompt = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]
            else:
                send_prompt = "ì•„ë˜ í•œêµ­ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]

    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="main_rev", help="ì½”ë“œ í’ˆì§ˆ/ì·¨ì•½ì /ê°€ë…ì„±ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•©ë‹ˆë‹¤."):
        if not guard_empty():
            send_prompt = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n" + st.session_state["__main_task_area"]

    if c4.button("ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°", use_container_width=True, key="main_send", help="ë¶™ì—¬ë„£ì€ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ì „ì†¡í•©ë‹ˆë‹¤."):
        if not guard_empty():
            send_prompt = st.session_state["__main_task_area"]

# ì»¤ìŠ¤í…€ ë°•ìŠ¤ì—ì„œ ëˆŒë €ë‹¤ë©´ ì¦‰ì‹œ ì „ì†¡(ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€) + ë‹¤ìŒ ëŸ°ì—ì„œ ì…ë ¥ì°½ ë¹„ìš°ê¸°
if send_prompt and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": send_prompt}
    history.append(user_msg)

    render_message("user", send_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

    # ë‹¤ìŒ ì‹¤í–‰ì—ì„œ í…ìŠ¤íŠ¸ë°•ìŠ¤ë¥¼ ë¹„ìš°ë„ë¡ í”Œë˜ê·¸ë§Œ ì„¤ì •
    st.session_state["__clear_main"] = True
    st.rerun()

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname = f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button(
        "ëŒ€í™” ë‚´ìš© ì €ì¥",
        data=json.dumps(st.session_state.messages, ensure_ascii=False, indent=2),
        file_name=fname,
        mime="application/json",
        use_container_width=True
    )
    st.caption("ëŒ€í™” ê¸°ë¡ì„ JSONìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")

# â”€â”€ ë¹Œë“œ íƒœê·¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
st.caption("build: streamlit_app.py Â· layout=wide Â· light theme")
í¬ì¸íŠ¸

**ê° ìœ„ì ¯ì— help**ë¥¼ ë‹¬ì•„ ë¡¤ì˜¤ë²„ íˆ´íŒ ì œê³µ.

ë²ˆì—­ ë°©í–¥ ë¼ë””ì˜¤(ì˜â†’í•œ/í•œâ†’ì˜) ë°˜ì˜.

ì‘ë‹µ í›„ ì…ë ¥ì°½ ë¹„ì›€: ê°™ì€ ëŸ°ì—ì„œ ê°’ ëŒ€ì… ê¸ˆì§€ â†’ __clear_main í”Œë˜ê·¸ + st.rerun() íŒ¨í„´ìœ¼ë¡œ ì•ˆì • ì²˜ë¦¬.

ë‚˜ì˜ ë§:
ì—…ë¡œë“œí•œ ì´ë¯¸ì§€
ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°ë¥¼ í•˜ë©´ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ì—ì„œì˜ ë‹µì´ ë‚˜ì™€ì•¼ í•˜ëŠ”ë° ìœ„ì—ì„œ ì§„í–‰í–ˆë˜  ê²°ê³¼ê°€ ì´ì–´ì§€ë©´ì„œ ë²ˆì—­ì´ ë˜ê±°ë‚˜ ìš”ì•½ì´ ë˜ì–´ì„œ ë‚˜ì˜¨ë‹¤. ì´ì „ ì‹¤í–‰ì— ì˜í–¥ì„ ë°›ì§€ ì•Šë„ë¡ ìˆ˜ì •í•´ì¤˜.
ChatGPTì˜ ë§:

25s ë™ì•ˆ ìƒê°í•¨
ì¢‹ì•„. â€œê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°â€ê°€ ì´ì „ ì‹¤í–‰(ìš”ì•½/ë²ˆì—­) ì˜í–¥ ì—†ì´ ë™ì‘í•˜ë„ë¡ ì „ì²´ ì½”ë“œë¥¼ ì†ë´¤ì–´.

í•µì‹¬ ìˆ˜ì •
ì»¨í…ìŠ¤íŠ¸ ëª¨ë“œ ì¶”ê°€: ëŒ€í™” ì—°ì† / ì´ì „ ëŒ€í™” ë¬´ì‹œ(ê¸°ë³¸)
â†’ ë²„íŠ¼ìœ¼ë¡œ ë³´ë‚¼ ë•Œ, ê¸°ë³¸ê°’ì€ ì´ì „ ëŒ€í™” ë¬´ì‹œë¼ì„œ ì´ì „ ìš”ì•½/ë²ˆì—­ ì§€ì‹œê°€ ìƒˆ ìš”ì²­ì— ë¼ì–´ë“¤ì§€ ì•ŠìŒ.

â€œê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°â€ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì´ì „ ëŒ€í™” ë¬´ì‹œ ëª¨ë“œë¥¼ ì‚¬ìš©(ì›í•˜ë©´ ëŒ€í™” ì—°ì†ìœ¼ë¡œ ë°”ê¿” ê°€ëŠ¥).

ê¸°ì¡´ì˜ íˆ´íŒ, ë²ˆì—­ ë°©í–¥, ì‘ë‹µ í›„ ì…ë ¥ì°½ ìë™ ë¹„ì›€, ì„¸ì…˜-ì„¸ì´í”„ ì´ˆê¸°í™” ìœ ì§€.

ì•„ë˜ íŒŒì¼ë¡œ êµì²´í•˜ì„¸ìš”.

# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ ë¼ì´íŠ¸ & ìƒí¼í•œ ì»¬ëŸ¬ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;
  --user:#ecfeff;
  --bot:#fff7ed;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
div.stTextInput>div>div>input, textarea, .stSelectbox [data-baseweb="select"]{
  background-color:#ffffff !important; color:var(--text) !important; border:1px solid var(--border) !important;
}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.chat-header{
  border:1px solid var(--border);
  background: linear-gradient(90deg, #f0fdf4, #ecfeff 60%, #f0f9ff);
  padding:16px 20px; border-radius:14px;
  box-shadow: 0 8px 24px rgba(2,132,199,.12);
}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
hr{border-color:var(--border);}
small.hint{color:var(--muted);}
kbd{background:#f8fafc; border:1px solid var(--border); border-bottom-width:2px; padding:1px 6px; border-radius:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ ìƒë‹¨ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ <b>ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸</b>ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
        <b>API KeyëŠ” ì…ë ¥ì°½ì— ë„£ìœ¼ë©´ ì„¸ì…˜ì— ì €ì¥</b>ë©ë‹ˆë‹¤(Secrets ë¶ˆí•„ìš”).
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ì„¸ì…˜ ì¤€ë¹„/ì´ˆê¸°í™”(ìœ„ì ¯ ìƒì„± ì „) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "__main_task_area" not in st.session_state:
    st.session_state["__main_task_area"] = ""
if "__trans_dir" not in st.session_state:
    st.session_state["__trans_dir"] = "ì˜â†’í•œ"
# ìƒˆë¡œ ì¶”ê°€: ì»¨í…ìŠ¤íŠ¸ ëª¨ë“œ (ê¸°ë³¸=ì´ì „ ëŒ€í™” ë¬´ì‹œ)
if "__ctx_mode" not in st.session_state:
    st.session_state["__ctx_mode"] = "ì´ì „ ëŒ€í™” ë¬´ì‹œ"  # ë˜ëŠ” "ëŒ€í™” ì—°ì†"
# ì´ì „ ëŸ°ì—ì„œ ì…ë ¥ì°½ ì´ˆê¸°í™” í”Œë˜ê·¸ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ë¨¼ì € ë¹„ìš°ê³  í”Œë˜ê·¸ í•´ì œ
if st.session_state.get("__clear_main"):
    st.session_state["__main_task_area"] = ""
    st.session_state["__clear_main"] = False

# â”€â”€ ì‚¬ì´ë“œë°”(ì„¤ì •/ìœ í‹¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input(
        "OpenAI API Key",
        value=key_default,
        type="password",
        help="OpenAI API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ìƒˆë¡œê³ ì¹¨ ì „ê¹Œì§€ ìœ ì§€ë©ë‹ˆë‹¤."
    )

    model = st.selectbox(
        "Model",
        options=["gpt-4o-mini", "gpt-4o", "gpt-4.1-mini", "gpt-3.5-turbo"],
        index=0,
        help="ì‚¬ìš©í•  OpenAI ëª¨ë¸ì„ ì„ íƒí•©ë‹ˆë‹¤.\n- gpt-4o-mini: ë¹ ë¥´ê³  ì €ë ´(ê°€ë²¼ìš´ ì‘ì—…)\n- gpt-4o: ê³ í’ˆì§ˆ ì‘ë‹µ\n- gpt-4.1-mini / gpt-3.5-turbo: ë¹„ìš© ì ˆê° ì˜µì…˜"
    )

    temperature = st.slider(
        "Temperature",
        0.0, 1.2, 0.7, 0.1,
        help="ì‘ë‹µì˜ ì°½ì˜ì„±(ëœë¤ì„±)ì„ ì¡°ì ˆí•©ë‹ˆë‹¤. ë‚®ì„ìˆ˜ë¡ ì¼ê´€ì„±â†‘, ë†’ì„ìˆ˜ë¡ ë‹¤ì–‘ì„±/ì°½ì˜ì„±â†‘"
    )

    max_tokens = st.slider(
        "Max tokens(ì‘ë‹µ)",
        256, 4096, 1024, 64,
        help="ëª¨ë¸ì´ í•œ ë²ˆì— ìƒì„±í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í† í° ìˆ˜(ë‹¨ì–´ ì¡°ê°). ê°’ì´ í´ìˆ˜ë¡ ê¸´ ë‹µë³€ ê°€ëŠ¥í•˜ì§€ë§Œ ë¹„ìš©/ì‹œê°„â†‘"
    )

    system_prompt = st.text_area(
        "System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ **êµµê²Œ** ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100,
        help="ëª¨ë¸ì˜ ê¸°ë³¸ ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì˜ˆ: 'ì¹œì ˆí•œ ì„ ìƒë‹˜ì²˜ëŸ¼ ì„¤ëª…í•´ì¤˜'"
    )

    st.divider()
    col_a, col_b = st.columns(2)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True, help="ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤.")
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True, help="í˜„ì¬ê¹Œì§€ì˜ ëŒ€í™” ë‚´ìš©ì„ JSONìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.")

# â”€â”€ ì„¸ì…˜ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str, str]] = []

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    if api_key_input and api_key_input.strip():
        st.session_state["OPENAI_API_KEY"] = api_key_input.strip()
    key = st.session_state.get("OPENAI_API_KEY", "").strip()
    if not key:
        return None
    try:
        return OpenAI(api_key=key)
    except openai.OpenAIError as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}", icon="ğŸ’¥")
        return None

client = get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë°(ë¬¸ìì—´ ì œë„ˆë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(
    _client: OpenAI,
    _messages: List[Dict[str, str]],
    _model: str,
    _temperature: float,
    _max_tokens: int,
) -> Generator[str, None, None]:
    resp = _client.chat.completions.create(
        model=_model,
        messages=_messages,
        temperature=_temperature,
        max_tokens=_max_tokens,
        stream=True,
    )
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta, "content", None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen: Generator[str, None, None]) -> str:
    if hasattr(st, "write_stream"):
        return st.write_stream(gen)
    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>'
            f'{"".join(acc)}</div>',
            unsafe_allow_html=True
        )
    return "".join(acc)

# â”€â”€ ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role == "assistant" else "user",
                         avatar="ğŸ¤–" if role == "assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{content}</div>',
            unsafe_allow_html=True
        )

for m in st.session_state.messages:
    render_message(m["role"], m["content"], m.get("time"))

# â”€â”€ í‚¤ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if client is None:
    st.info("ì‚¬ì´ë“œë°”ì— **OpenAI API Key**ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤.", icon="ğŸ”")

# â”€â”€ ììœ  ì±„íŒ… ì…ë ¥(í•˜ë‹¨ ê³ ì •) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
if user_input and client:
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})
    history.extend(st.session_state.messages)
    user_msg = {"role": "user", "content": user_input}
    history.append(user_msg)

    render_message("user", user_input)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

# â”€â”€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤(í…ìŠ¤íŠ¸ + ë²ˆì—­ ë°©í–¥ + ì»¨í…ìŠ¤íŠ¸ ëª¨ë“œ + ì•¡ì…˜ ë²„íŠ¼) â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
with st.container():
    st.markdown("#### í”„ë¡¬í”„íŠ¸")
    main_text = st.text_area(
        "ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  ìš”ì•½/ë²ˆì—­/ë¦¬ë·°/ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.",
        key="__main_task_area",
        height=160,
        label_visibility="collapsed",
        placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°â€¦"
    )

    cols = st.columns([1,1,1])
    with cols[0]:
        trans_dir = st.radio(
            "ë²ˆì—­ ë°©í–¥",
            options=("ì˜â†’í•œ", "í•œâ†’ì˜"),
            horizontal=True,
            key="__trans_dir",
            help="ë²ˆì—­ ë°©í–¥ì„ ì„ íƒí•˜ì„¸ìš”. ì„ íƒì— ë”°ë¼ ë²ˆì—­ í”„ë¡¬í”„íŠ¸ê°€ ìë™ êµ¬ì„±ë©ë‹ˆë‹¤."
        )
    with cols[1]:
        ctx_mode = st.radio(
            "ì»¨í…ìŠ¤íŠ¸",
            options=("ëŒ€í™” ì—°ì†", "ì´ì „ ëŒ€í™” ë¬´ì‹œ"),
            index=1,  # ê¸°ë³¸ê°’: ì´ì „ ëŒ€í™” ë¬´ì‹œ
            key="__ctx_mode",
            help="ëŒ€í™” ì—°ì†: ì´ì „ ëŒ€í™” ë§¥ë½ì„ í•¨ê»˜ ë³´ëƒ„\nì´ì „ ëŒ€í™” ë¬´ì‹œ: ì§€ê¸ˆ ì…ë ¥ë§Œ ë‹¨ë…ìœ¼ë¡œ ë³´ëƒ„"
        )
    with cols[2]:
        st.write("")  # spacing

    c1, c2, c3, c4 = st.columns([1,1,1,1])
    send_prompt = None
    action = None  # 'summary' | 'translate' | 'review' | 'send_raw'

    def guard_empty() -> bool:
        if not (st.session_state["__main_task_area"] or "").strip():
            st.warning("í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", icon="âš ï¸")
            return True
        return False

    if c1.button("ìš”ì•½(3ì¤„)", use_container_width=True, key="main_sum",
                 help="ë¶™ì—¬ë„£ì€ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•©ë‹ˆë‹¤."):
        if not guard_empty():
            send_prompt = "ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]
            action = "summary"

    if c2.button("ë²ˆì—­", use_container_width=True, key="main_tr",
                 help="ì„ íƒí•œ ë°©í–¥(ì˜â†’í•œ/í•œâ†’ì˜)ìœ¼ë¡œ ë²ˆì—­í•©ë‹ˆë‹¤."):
        if not guard_empty():
            if st.session_state["__trans_dir"] == "ì˜â†’í•œ":
                send_prompt = "ì•„ë˜ ì˜ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]
            else:
                send_prompt = "ì•„ë˜ í•œêµ­ì–´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ë¡œ ë²ˆì—­í•´ì¤˜:\n\n" + st.session_state["__main_task_area"]
            action = "translate"

    if c3.button("ì½”ë“œ ë¦¬ë·°", use_container_width=True, key="main_rev",
                 help="ì½”ë“œ í’ˆì§ˆ/ì·¨ì•½ì /ê°€ë…ì„±ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•©ë‹ˆë‹¤."):
        if not guard_empty():
            send_prompt = "ì•„ë˜ ì½”ë“œì—ì„œ ì·¨ì•½ì /ê°€ë…ì„±/ì„±ëŠ¥ì„ ë¦¬ë·°í•˜ê³  ìˆ˜ì • ì˜ˆì‹œë¥¼ ì œì‹œí•´ì¤˜:\n\n" + st.session_state["__main_task_area"]
            action = "review"

    if c4.button("ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°", use_container_width=True, key="main_send",
                 help="ë¶™ì—¬ë„£ì€ í…ìŠ¤íŠ¸ë¥¼ ê°€ê³µ ì—†ì´ ê·¸ëŒ€ë¡œ ì „ì†¡í•©ë‹ˆë‹¤. (ê¸°ë³¸: ì´ì „ ëŒ€í™” ë¬´ì‹œ)"):
        if not guard_empty():
            send_prompt = st.session_state["__main_task_area"]
            action = "send_raw"
            # ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë§¥ë½ì„ ë¬´ì‹œí•˜ë„ë¡ ê°•ì œí•  ìˆ˜ë„ ìˆìŒ:
            # ctx_mode = "ì´ì „ ëŒ€í™” ë¬´ì‹œ"
            # st.session_state["__ctx_mode"] = "ì´ì „ ëŒ€í™” ë¬´ì‹œ"

# ì»¤ìŠ¤í…€ ë°•ìŠ¤ì—ì„œ ëˆŒë €ë‹¤ë©´ ì¦‰ì‹œ ì „ì†¡ + ë‹¤ìŒ ëŸ°ì—ì„œ ì…ë ¥ì°½ ë¹„ìš°ê¸°
if send_prompt and client:
    # === ì»¨í…ìŠ¤íŠ¸ ì„ íƒ ì ìš© ===
    history: List[Dict[str, str]] = []
    if system_prompt.strip():
        history.append({"role": "system", "content": system_prompt.strip()})

    use_history = (st.session_state["__ctx_mode"] == "ëŒ€í™” ì—°ì†")
    # "ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°"ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì´ì „ ëŒ€í™” ë¬´ì‹œë¥¼ ê¶Œì¥
    if action == "send_raw" and st.session_state["__ctx_mode"] != "ëŒ€í™” ì—°ì†":
        use_history = False

    if use_history:
        history.extend(st.session_state.messages)

    # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    user_msg = {"role": "user", "content": send_prompt}
    history.append(user_msg)

    # ë Œë” + ì„¸ì…˜ ì €ì¥
    render_message("user", send_prompt)
    st.session_state.messages.append({**user_msg, "time": datetime.now().strftime("%H:%M")})

    # ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ
    with st.chat_message("assistant", avatar="ğŸ¤–"):
        try:
            response_text = write_stream_safe(
                stream_completion_text(client, history, model, temperature, max_tokens)
            )
        except openai.AuthenticationError:
            st.error("**ì¸ì¦ ì˜¤ë¥˜(401)**: API Keyê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", icon="ğŸš«"); st.stop()
        except openai.PermissionDeniedError:
            st.error("**ê¶Œí•œ ì˜¤ë¥˜(403)**: ì„ íƒí•œ ëª¨ë¸ ê¶Œí•œ ì—†ìŒ.", icon="ğŸ”’"); st.stop()
        except openai.RateLimitError:
            st.warning("**ìš”ì²­ ì œí•œ(429)**: ì ì‹œ í›„ ì¬ì‹œë„.", icon="â³"); st.stop()
        except openai.BadRequestError as e:
            st.error(f"**ìš”ì²­ ì˜¤ë¥˜(400)**: {e}", icon="â—"); st.stop()
        except openai.OpenAIError as e:
            st.error(f"OpenAI ì˜¤ë¥˜: {e}", icon="ğŸ’¥"); st.stop()

    st.session_state.messages.append(
        {"role": "assistant", "content": response_text or "(ì‘ë‹µ ì—†ìŒ)", "time": datetime.now().strftime("%H:%M")}
    )

    # ë‹¤ìŒ ì‹¤í–‰ì—ì„œ í…ìŠ¤íŠ¸ë°•ìŠ¤ë¥¼ ë¹„ìš°ë„ë¡ í”Œë˜ê·¸ë§Œ ì„¤ì •
    st.session_state["__clear_main"] = True
    st.rerun()

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname = f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button(
        "ëŒ€í™” ë‚´ìš© ì €ì¥",
        data=json.dumps(st.session_state.messages, ensure_ascii=False, indent=2),
        file_name=fname,
        mime="application/json",
        use_container_width=True
    )
    st.caption("ëŒ€í™” ê¸°ë¡ì„ JSONìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")

# â”€â”€ ë¹Œë“œ íƒœê·¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>", unsafe_allow_html=True)
st.caption("build: streamlit_app.py Â· layout=wide Â· light theme")
ì´ì œ ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°ë¥¼ ëˆŒëŸ¬ë„ ì´ì „ ìš”ì•½/ë²ˆì—­ ë§¥ë½ì— ëŒë ¤ê°€ì§€ ì•Šê³ , ì»¨í…ìŠ¤íŠ¸ ë¼ë””ì˜¤ë¡œ í•„ìš” ì‹œë§Œ ëŒ€í™” ì—°ì†ì„ ì„ íƒí•´ ì“¸ ìˆ˜ ìˆì–´.

ë‚˜ì˜ ë§:
** ì´ê²Œ ì•ˆ ë¶™ê²Œ ìˆ˜ì •í•´ì¤˜ ì˜ ê°€ë…ì„±ì´ ë–¨ì–´ì§€ë„¤
ChatGPTì˜ ë§:

27s ë™ì•ˆ ìƒê°í•¨
ì˜¤ì¼€ì´. ì¶œë ¥ì—ì„œ **ê°€ ì•„ì˜ˆ ë³´ì´ì§€ ì•Šë„ë¡ ìŠ¤íŠ¸ë¦¬ë° ë‹¨ê³„ì—ì„œ ë§ˆí¬ë‹¤ìš´ êµµê²Œ/ì´íƒ¤ë¦­ í‘œì‹ì„ ì œê±°í•´ ë²„ë¦¬ê²Œ ìˆ˜ì •í•˜ì. (ì´ëŸ¬ë©´ ëª¨ë¸ì´ **êµµê²Œ**ë¥¼ ì¨ë„ UIì—ëŠ” ê¹”ë”í•œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œë¨)

ë³€ê²½ ìš”ì 
ë§ˆí¬ë‹¤ìš´ ì„œì‹ ì œê±° í•¨ìˆ˜ ì¶”ê°€(strip_md).

ìŠ¤íŠ¸ë¦¬ë° ì¶œë ¥ ê²½ë¡œë¥¼ ê°•ì œ ì»¤ìŠ¤í…€ ë Œë”ë§ìœ¼ë¡œ ì‚¬ìš©í•´, í† í°ì„ ëˆ„ì í•˜ë©´ì„œ í•­ìƒ ì„œì‹ ì œê±° í›„ í‘œì‹œ.

ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œì—ì„œ ** ì œê±°.

ì•„ë˜ íŒ¨ì¹˜ë§Œ ì ìš©í•˜ë©´ ë¼. (íŒŒì¼ ì „ì²´ êµì²´ í•„ìš” ì—†ìŒ)

# ìƒë‹¨ import ê·¼ì²˜ì— ì¶”ê°€
import re
# ìŠ¤íŠ¸ë¦¬ë° ìœ„ì— ìœ í‹¸ ì¶”ê°€
USE_NATIVE_STREAM = False  # Trueë©´ st.write_stream ì‚¬ìš©, Falseë©´ ì»¤ìŠ¤í…€ ë Œë”ë§(ì„œì‹ ì œê±°)

def strip_md(s: str) -> str:
    """êµµê²Œ/ì´íƒ¤ë¦­ ë§ˆí¬ë‹¤ìš´(**, *, __, _)ì„ ì œê±°"""
    s = re.sub(r"\*\*(.*?)\*\*", r"\1", s, flags=re.S)  # **bold**
    s = re.sub(r"\*(.*?)\*", r"\1", s)                  # *italic*
    s = re.sub(r"__(.*?)__", r"\1", s, flags=re.S)      # __bold__
    s = re.sub(r"_(.*?)_", r"\1", s)                    # _italic_
    s = s.replace("**", "")  # ë¹„ì •ìƒ ì”ì—¬ ì²˜ë¦¬
    return s
# ì‚¬ì´ë“œë°”ì˜ system_prompt ê¸°ë³¸ê°’ ë¬¸ìì—´ì—ì„œ ** ì œê±°
system_prompt = st.text_area(
    "System prompt",
    value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ êµµê²Œ ê°•ì¡°í•˜ì§€ ë§ê³ , ëª…í™•í•œ bulletë¡œë§Œ ì •ë¦¬í•©ë‹ˆë‹¤.",
    height=100,
    help="ëª¨ë¸ì˜ ê¸°ë³¸ ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì˜ˆ: 'ì¹œì ˆí•œ ì„ ìƒë‹˜ì²˜ëŸ¼ ì„¤ëª…í•´ì¤˜'"
)
# write_stream_safe êµì²´
def write_stream_safe(gen: Generator[str, None, None]) -> str:
    """
    st.write_stream ëŒ€ì‹  ì»¤ìŠ¤í…€ ë Œë”ë§ì„ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•´ì„œ
    ** ë“± ë§ˆí¬ë‹¤ìš´ ì„œì‹ì„ ì œê±°í•œ í…ìŠ¤íŠ¸ë¥¼ ì‹¤ì‹œê°„ í‘œì‹œ/ë°˜í™˜.
    """
    if USE_NATIVE_STREAM and hasattr(st, "write_stream"):
        # ë„¤ì´í‹°ë¸Œ ìŠ¤íŠ¸ë¦¼ì„ ì“°ê³  ì‹¶ìœ¼ë©´ Trueë¡œ ë°”ê¿” ì‚¬ìš© (ì„œì‹ ì œê±° ì•ˆ ë¨)
        return st.write_stream(gen)

    ph = st.empty()
    acc = []
    for tok in gen:
        acc.append(tok)
        # ëˆ„ì  ë¬¸ìì—´ì„ ì„œì‹ ì œê±°í•˜ê³  ì¶œë ¥
        safe_text = strip_md("".join(acc))
        ph.markdown(
            f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>{safe_text}</div>',
            unsafe_allow_html=True
        )
    return strip_md("".join(acc))
ì°¸ê³ : ìš°ë¦¬ëŠ” write_stream_safe(...)ì˜ ë°˜í™˜ê°’(ìµœì¢… í…ìŠ¤íŠ¸)ë„ ì„œì‹ ì œê±°ëœ ê²ƒì„ ëŒë ¤ì£¼ë¯€ë¡œ, ì„¸ì…˜ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë˜ëŠ” ë‚´ìš© ì—­ì‹œ **ê°€ ì—†ìŠµë‹ˆë‹¤. ê³¼ê±° ëŒ€í™”ì— ë‚¨ì•„ ìˆë˜ **ëŠ” ê·¸ëŒ€ë¡œì§€ë§Œ, ì´í›„ ì‘ë‹µë¶€í„°ëŠ” ì „ë¶€ ê¹”ë”í•œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ë‚˜ì˜µë‹ˆë‹¤.

í•„ìš”í•˜ë©´ strip_mdì— ëª©ë¡/í—¤ë”© ì œê±°ê¹Œì§€ í™•ëŒ€í•´ ì¤„ ìˆ˜ë„ ìˆì–´. ì§€ê¸ˆì€ êµµê²Œ/ì´íƒ¤ë¦­ë§Œ ì œê±°í•´ì„œ ë³¸ë¬¸ ê°€ë…ì„±ë§Œ ì†ë´¤ì–´.

ë‚˜ì˜ ë§:
ì „ì²´ ì½”ë“œ
ChatGPTì˜ ë§:
ì¢‹ì•„ ë„ë¦¬, ìš”ì²­ëŒ€ë¡œ ì „ì²´ ì½”ë“œë¥¼ ë‹¤ì‹œ ì •ë¦¬í–ˆì–´.
ì´ë²ˆ ë²„ì „ì€ ** ê°™ì€ ë§ˆí¬ë‹¤ìš´ ì„œì‹ ì œê±°, íˆ´íŒ(hover ì„¤ëª…), í”„ë¡¬í”„íŠ¸ ì…ë ¥ í›„ ìë™ ë¹„ì›€, ì»¨í…ìŠ¤íŠ¸(ëŒ€í™” ì—°ì†/ì´ì „ ëŒ€í™” ë¬´ì‹œ), ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸° ì˜¤ë¥˜ ìˆ˜ì •ê¹Œì§€ ëª¨ë‘ ë°˜ì˜ë¼.

# streamlit_app.py
from __future__ import annotations
import json
from datetime import datetime
from typing import Dict, List, Generator, Optional
import re

import streamlit as st
import openai
from openai import OpenAI

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="Chatbot",
    page_icon="ğŸ’¬",
    layout="wide",
    initial_sidebar_state="expanded",
)

# â”€â”€ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --acc:#10b981;
  --user:#ecfeff;
  --bot:#fff7ed;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
}
html, body, [data-testid="stAppViewContainer"]{
  background: radial-gradient(1200px 800px at 10% 10%, #f0f9ff 0%, var(--bg) 70%) !important;
  color: var(--text) !important;
}
section[data-testid="stSidebar"]{
  background-color: var(--card) !important;
  border-right: 1px solid var(--border);
}
.block-container{padding-top: 1.0rem;}
.stButton>button{
  background: linear-gradient(90deg, #34d399, #10b981);
  border:0; color:white; font-weight:700;
  box-shadow: 0 4px 14px rgba(16,185,129,.25);
}
.stButton>button:hover{filter:brightness(1.04);}
.msg{border:1px solid var(--border); padding:14px 16px; border-radius:14px; margin:8px 0; line-height:1.55;}
.msg.user{background-color: var(--user);}
.msg.bot{background-color: var(--bot);}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px;}
</style>
""", unsafe_allow_html=True)

# â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown(
    """
    <div class="chat-header">
      <h2 style="margin:0;">ğŸ’¬ Chatbot</h2>
      <div style="color:#6b7280;margin-top:6px;">
        OpenAI Chat API ê¸°ë°˜. ì¢Œì¸¡ì—ì„œ ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.
      </div>
    </div>
    """,
    unsafe_allow_html=True
)

# â”€â”€ ìœ í‹¸ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def strip_md(s: str) -> str:
    """êµµê²Œ/ì´íƒ¤ë¦­ ë§ˆí¬ë‹¤ìš´(**, *, __, _) ì œê±°"""
    s = re.sub(r"\*\*(.*?)\*\*", r"\1", s, flags=re.S)
    s = re.sub(r"\*(.*?)\*", r"\1", s)
    s = re.sub(r"__(.*?)__", r"\1", s, flags=re.S)
    s = re.sub(r"_(.*?)_", r"\1", s)
    return s.replace("**", "")

def render_message(role: str, content: str, when: Optional[str] = None):
    meta = when or datetime.now().strftime("%H:%M")
    with st.chat_message("assistant" if role=="assistant" else "user",
                         avatar="ğŸ¤–" if role=="assistant" else "ğŸ§‘"):
        st.markdown(
            f'<div class="msg {"bot" if role=="assistant" else "user"}">'
            f'<div class="meta">{role} Â· {meta}</div>{strip_md(content)}</div>',
            unsafe_allow_html=True
        )

# â”€â”€ ì„¸ì…˜ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages: List[Dict[str,str]] = []
if "__main_task_area" not in st.session_state:
    st.session_state["__main_task_area"] = ""
if "__clear_main" not in st.session_state:
    st.session_state["__clear_main"] = False
if "__ctx_mode" not in st.session_state:
    st.session_state["__ctx_mode"] = "ì´ì „ ëŒ€í™” ë¬´ì‹œ"
if st.session_state["__clear_main"]:
    st.session_state["__main_task_area"] = ""
    st.session_state["__clear_main"] = False

# â”€â”€ ì‚¬ì´ë“œë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.subheader("í™˜ê²½ ì„¤ì •")

    key_default = st.session_state.get("OPENAI_API_KEY", "")
    api_key_input = st.text_input("OpenAI API Key", value=key_default, type="password",
        help="OpenAI API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì„¸ì…˜ì— ì €ì¥ë˜ì–´ ìƒˆë¡œê³ ì¹¨ ì „ê¹Œì§€ ìœ ì§€ë©ë‹ˆë‹¤.")

    model = st.selectbox(
        "Model",
        ["gpt-4o-mini","gpt-4o","gpt-4.1-mini","gpt-3.5-turbo"],
        index=0,
        help="ëª¨ë¸ ì¢…ë¥˜ ì„ íƒ\n- 4o-mini: ë¹ ë¥´ê³  ì €ë ´\n- 4o: ê³ í’ˆì§ˆ\n- 3.5/4.1-mini: ë¹„ìš© ì ˆê°"
    )
    temperature = st.slider("Temperature",0.0,1.2,0.7,0.1,
        help="ì°½ì˜ì„± ì¡°ì ˆ: ë‚®ì„ìˆ˜ë¡ ì¼ê´€ì„±â†‘, ë†’ì„ìˆ˜ë¡ ë‹¤ì–‘ì„±/ì°½ì˜ì„±â†‘")
    max_tokens = st.slider("Max tokens(ì‘ë‹µ)",256,4096,1024,64,
        help="ëª¨ë¸ì´ í•œ ë²ˆì— ìƒì„±í•  ìµœëŒ€ í† í° ìˆ˜. ê°’â†‘ = ê¸´ ì‘ë‹µ ê°€ëŠ¥")
    system_prompt = st.text_area("System prompt",
        value="ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ë©´ì„œ ê°„ê²°í•œ í•œêµ­ì–´ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•µì‹¬ì€ ëª…í™•í•˜ê²Œ ê°•ì¡°í•©ë‹ˆë‹¤.",
        height=100,
        help="ëª¨ë¸ì˜ ê¸°ë³¸ ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.")

    st.divider()
    col_a,col_b = st.columns(2)
    clear_clicked = col_a.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True)
    download_clicked = col_b.button("ë‚´ë ¤ë°›ê¸°(JSON)", use_container_width=True)

if clear_clicked:
    st.session_state.messages = []
    st.rerun()

# â”€â”€ OpenAI Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_client() -> Optional[OpenAI]:
    if api_key_input: st.session_state["OPENAI_API_KEY"]=api_key_input.strip()
    key = st.session_state.get("OPENAI_API_KEY","").strip()
    if not key: return None
    try: return OpenAI(api_key=key)
    except: return None

client=get_client()

# â”€â”€ ìŠ¤íŠ¸ë¦¬ë° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def stream_completion_text(_client:OpenAI,_messages:List[Dict[str,str]],_model:str,_temperature:float,_max_tokens:int)->Generator[str,None,None]:
    resp=_client.chat.completions.create(model=_model,messages=_messages,temperature=_temperature,max_tokens=_max_tokens,stream=True)
    for chunk in resp:
        if chunk.choices and getattr(chunk.choices[0].delta,"content",None):
            yield chunk.choices[0].delta.content

def write_stream_safe(gen:Generator[str,None,None])->str:
    ph=st.empty();acc=[]
    for tok in gen:
        acc.append(tok)
        safe=strip_md("".join(acc))
        ph.markdown(f'<div class="msg bot"><div class="meta">assistant Â· {datetime.now():%H:%M}</div>{safe}</div>',unsafe_allow_html=True)
    return strip_md("".join(acc))

# â”€â”€ ê³¼ê±° ë©”ì‹œì§€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for m in st.session_state.messages:
    render_message(m["role"],m["content"],m.get("time"))

# â”€â”€ ììœ  ì…ë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
if user_input and client:
    history=[{"role":"system","content":system_prompt.strip()}] if system_prompt.strip() else []
    history.extend(st.session_state.messages)
    user_msg={"role":"user","content":user_input}
    history.append(user_msg)
    render_message("user",user_input)
    st.session_state.messages.append({**user_msg,"time":datetime.now().strftime("%H:%M")})
    with st.chat_message("assistant",avatar="ğŸ¤–"):
        response_text=write_stream_safe(stream_completion_text(client,history,model,temperature,max_tokens))
    st.session_state.messages.append({"role":"assistant","content":response_text,"time":datetime.now().strftime("%H:%M")})

# â”€â”€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("<hr/>",unsafe_allow_html=True)
st.markdown("#### í”„ë¡¬í”„íŠ¸")
main_text=st.text_area("ì…ë ¥ì°½",key="__main_task_area",height=160,label_visibility="collapsed",placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦")
ctx_mode=st.radio("ì»¨í…ìŠ¤íŠ¸",["ëŒ€í™” ì—°ì†","ì´ì „ ëŒ€í™” ë¬´ì‹œ"],index=1,key="__ctx_mode")

c1,c2,c3,c4=st.columns(4)
send_prompt=None;action=None

def guard_empty():
    if not main_text.strip():
        st.warning("í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.");return True
    return False

if c1.button("ìš”ì•½(3ì¤„)",use_container_width=True):
    if not guard_empty(): send_prompt="ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ 3ì¤„ë¡œ ìš”ì•½:\n\n"+main_text;action="sum"
if c2.button("ë²ˆì—­",use_container_width=True):
    if not guard_empty(): send_prompt="ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë²ˆì—­:\n\n"+main_text;action="tr"
if c3.button("ì½”ë“œ ë¦¬ë·°",use_container_width=True):
    if not guard_empty(): send_prompt="ì•„ë˜ ì½”ë“œ ë¦¬ë·°:\n\n"+main_text;action="rev"
if c4.button("ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°",use_container_width=True):
    if not guard_empty(): send_prompt=main_text;action="raw"

if send_prompt and client:
    history=[{"role":"system","content":system_prompt.strip()}] if system_prompt.strip() else []
    if st.session_state["__ctx_mode"]=="ëŒ€í™” ì—°ì†": history.extend(st.session_state.messages)
    history.append({"role":"user","content":send_prompt})
    render_message("user",send_prompt)
    st.session_state.messages.append({"role":"user","content":send_prompt,"time":datetime.now().strftime("%H:%M")})
    with st.chat_message("assistant",avatar="ğŸ¤–"):
        response_text=write_stream_safe(stream_completion_text(client,history,model,temperature,max_tokens))
    st.session_state.messages.append({"role":"assistant","content":response_text,"time":datetime.now().strftime("%H:%M")})
    st.session_state["__clear_main"]=True
    st.rerun()

# â”€â”€ ë‚´ë ¤ë°›ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if download_clicked:
    fname=f"chat_{datetime.now():%Y%m%d_%H%M%S}.json"
    st.download_button("ëŒ€í™” ì €ì¥",data=json.dumps(st.session_state.messages,ensure_ascii=False,indent=2),file_name=fname,mime="application/json")
ì´ì œ ê²°ê³¼ì—ì„œ **ê°€ ì™„ì „íˆ ì‚¬ë¼ì ¸ì„œ ê°€ë…ì„±ì´ ì¢‹ì•„ì§€ê³ , ê·¸ëŒ€ë¡œ ë³´ë‚´ê¸°ë„ ì´ì „ ì‹¤í–‰ì— ì•ˆ ëŒë ¤.
ë„ë¦¬, í˜¹ì‹œ ê²°ê³¼ë¥¼ **ìˆœìˆ˜ í…ìŠ¤íŠ¸(st.text)**ë¡œë§Œ ë¿Œë¦¬ê¸¸ ì›í•´? (ë§ˆí¬ë‹¤ìš´ íƒœê·¸ë„ ì™„ì „íˆ ì œê±°)



ì„ íƒëœ íŒŒì¼ ì—†ìŒì„ íƒëœ íŒŒì¼ ì—†ìŒ
ChatGPTëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.
